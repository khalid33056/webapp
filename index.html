<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotex QTX Airdrop Game</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Define Simple Blue Professional Colors */
        :root {
            --primary-blue: #0077ff; /* Clean, professional blue */
            --dark-bg: #151d28; /* Very dark background for contrast */
            --card-bg: #1e293b; /* Slightly lighter dark background for cards */
            --text-color: #e2e8f0;
        }

        body {
            background-color: var(--dark-bg); 
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
            user-select: none; 
        }
        
        /* --- General Component Styling --- */
        .card {
            background-color: var(--card-bg); 
            border: 1px solid #334155;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            transition: all 0.2s;
        }

        .professional-heading {
            color: var(--primary-blue);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        /* --- Navigation Bar --- */
        .nav-button {
            transition: all 0.2s;
            position: relative;
            color: #94a3b8; /* Simple gray for inactive */
        }
        .nav-button.active {
            color: var(--primary-blue);
            transform: scale(1.05);
            font-weight: 600;
        }
        .nav-button.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background-color: var(--primary-blue);
            border-radius: 50%;
        }

        /* --- Home Page Specifics --- */
        .mining-core {
            border: 4px solid var(--primary-blue);
            background: radial-gradient(circle, rgba(0, 119, 255, 0.3) 0%, rgba(0, 119, 255, 0.1) 70%);
            box-shadow: 0 0 20px rgba(0, 119, 255, 0.7);
        }

        /* ADJUSTED SIZE: Reduced padding and text size for a smaller timer display */
        .farm-timer-display {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--primary-blue);
            padding: 0.5rem; /* Reduced from 0.75rem */
            border-radius: 12px;
            font-family: monospace; 
            letter-spacing: 2px;
        }

        /* --- Daily Check-in Button Fixed Position --- */
        .checked-in-fixed {
            position: fixed;
            bottom: calc(4.5rem + 15px); 
            right: 15px;
            z-index: 40;
            transition: transform 0.3s ease-in-out, background-color 0.3s;
        }
        
        /* --- Boost Package Styling --- */
        .boost-package {
            background-color: #2b3952;
            border: 2px solid var(--primary-blue);
            box-shadow: 0 0 10px rgba(0, 119, 255, 0.3);
            height: 100%; 
        }

        /* Manual TON Connect Button */
        .manual-connect-btn {
            background: linear-gradient(135deg, #0077ff, #00a8ff);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }
        .manual-connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 119, 255, 0.4);
        }
        .manual-connect-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* TON Connect Button Styling */
        .ton-connect-button {
            width: 100%;
            margin-bottom: 1rem;
            min-height: 48px; /* Ensure consistent height */
        }

        /* Custom scrollbar for better aesthetics */
        .custom-scroll {
            overflow-y: auto;
        }
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: var(--primary-blue);
            border-radius: 2px;
        }

        /* Modal styling fixes */
        #generic-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

    <!-- Main App Container -->
    <div id="app" class="min-h-screen pb-20 max-w-md mx-auto relative custom-scroll">
        <!-- Content will be rendered here -->
    </div>

    <!-- Generic Full-Screen Modal (Used for Quotex Warning and Check-in) -->
    <div id="generic-modal" class="fixed inset-0 bg-gray-900/90 hidden items-center justify-center p-4 z-50">
        <div id="modal-content" class="w-full max-w-sm card p-6 rounded-2xl shadow-2xl border-2 border-blue-600/50">
            <!-- Modal Content rendered by custom functions -->
        </div>
    </div>

    <!-- Bottom Navigation Bar (Fixed for Mobile) -->
    <nav class="fixed bottom-0 left-0 right-0 h-16 bg-[#1e293b] border-t border-[#334155] max-w-md mx-auto z-30 shadow-2xl">
        <div class="flex justify-around h-full items-center">
            <button class="nav-button active flex flex-col items-center text-xs" onclick="navigateTo('home')">
                <i data-lucide="pickaxe" class="w-6 h-6"></i>
                <span class="mt-1">Mine</span>
            </button>
            <button class="nav-button flex flex-col items-center text-xs" onclick="navigateTo('tasks')">
                <i data-lucide="list-checks" class="w-6 h-6"></i>
                <span class="mt-1">Tasks</span>
            </button>
            <button class="nav-button flex flex-col items-center text-xs" onclick="navigateTo('presale')">
                <i data-lucide="rocket" class="w-6 h-6"></i>
                <span class="mt-1">Presale</span>
            </button>
            <button class="nav-button flex flex-col items-center text-xs" onclick="navigateTo('boost')">
                <i data-lucide="zap" class="w-6 h-6"></i>
                <span class="mt-1">Boost</span>
            </button>
            <button class="nav-button flex flex-col items-center text-xs" onclick="navigateTo('airdrop')">
                <i data-lucide="gift" class="w-6 h-6"></i>
                <span class="mt-1">Airdrop</span>
            </button>
             <button class="nav-button flex flex-col items-center text-xs" onclick="navigateTo('wallet')">
                <i data-lucide="wallet" class="w-6 h-6"></i>
                <span class="mt-1">Wallet</span>
            </button>
        </div>
    </nav>

    <!-- TON Connect UI Script -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <script>
        // --- GLOBAL STATE & CONFIGURATION ---
        const QTX_TOKEN = "QTX";
        const PRESALE_RATE = 7.0; // 1 TON = 7 QTX
        const BASE_FARMING_REWARD = 0.2;
        const FARMING_COOLDOWN_MS = 6 * 60 * 60 * 1000; // 6 hours
        const WELCOME_REWARD = 1.0;
        const REFERRAL_COMMISSION_RATE = 0.10; // 10% commission on friend's base farm claim
        const QUOTEX_JOIN_LINK = 'https://qxbroker.com/en/sign-in/';
        const QUOTEX_REWARD_MS = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
        
        const TOTAL_SUPPLY = 10000000;

        // Tokenomics data for the Whitepaper section
        const TOKEN_ALLOCATION = {
            farmingRewards: { 
                percentage: 25, 
                tokens: 0.25 * TOTAL_SUPPLY,
                details: [
                    { name: 'Airdrop & Farming Incentives', percentage: 20, tokens: 0.20 * TOTAL_SUPPLY },
                    { name: 'Referral & Community Milestones', percentage: 5, tokens: 0.05 * TOTAL_SUPPLY },
                ]
            },
            presale: { percentage: 15, tokens: 0.15 * TOTAL_SUPPLY }, 
            team: { percentage: 5, tokens: 0.05 * TOTAL_SUPPLY },
            liquidityEcosystem: { 
                percentage: 55, 
                tokens: 0.55 * TOTAL_SUPPLY 
            }, 
        };

        const REFERRAL_TIERS = [
            { count: 1, reward: 2.0, claimed: false },
            { count: 3, reward: 5.0, claimed: false },
            { count: 10, reward: 15.0, claimed: false },
        ];

        const BOOST_PACKAGES = [
            { name: "Bronze Miner", multiplier: 1.5, durationHours: 24, priceTon: 0.1, icon: 'shield' },
            { name: "Silver Drill", multiplier: 2.0, durationHours: 48, priceTon: 0.25, icon: 'shield-half' },
            { name: "Gold Rig", multiplier: 3.0, durationHours: 72, priceTon: 0.5, icon: 'shield-check' },
            { name: "Diamond Core", multiplier: 5.0, durationHours: 120, priceTon: 1.0, icon: 'sparkles' },
            { name: "Mega Whale", multiplier: 10.0, durationHours: 168, priceTon: 2.5, icon: 'gem' },
        ];

        const DAILY_REWARDS_SCHEDULE = [
            0.2, 0.2, 0.2, 0.2, 0.4, 
            0.4, 0.4, 0.4, 0.4, 0.6, 
            0.6, 0.6, 0.6, 0.6, 3.0, 
            0.8, 0.8, 0.8, 0.8, 1.0, 
            1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 10.0
        ];
        
        let globalState = {
            currentPage: 'home',
            
            // User Data - ALL RESET TO ZERO
            userId: 'user-' + Math.random().toString(36).substring(2, 9),
            balance: 0.0,
            farmClaimCount: 0, // Track the number of successful farm claims
            referralCount: 0,
            currentRank: 0, // Reset to 0
            
            connectedWallet: null,
            walletBalance: 0.0,
            
            // Farming State
            farmReadyTime: 0, 
            
            // Task State - ALL RESET TO INCOMPLETE
            tasks: {
                joinTelegram: { completed: false, reward: 10.0, title: 'Join Telegram Channel' },
                followTwitter: { completed: false, reward: 10.0, title: 'Follow us on X (Twitter)' },
                joinCommunity: { completed: false, reward: 7.0, title: 'Join Telegram Community' },
                // QUOTEX TASK
                quotex: { 
                    completed: false, 
                    reward: 12.5, 
                    title: 'Join Quotex platform', 
                    // status: 'initial', 'pending_id', 'loading', 'complete'
                    status: 'initial', 
                    quotexId: null, 
                    idEntryTime: 0 
                },
                // NEW: Presale Bonus Task
                presaleBonus: { 
                    completed: false, 
                    reward: 15.0, 
                    title: 'Presale Purchase Bonus (Min 0.1 TON)',
                    metRequirement: false, // Internal flag to track if criteria was met
                },
            },
            referralTiers: JSON.parse(JSON.stringify(REFERRAL_TIERS)), 

            // Presale History (Empty)
            presaleHistory: [],
            
            // Boost State
            activeBoost: {
                multiplier: 1.0,
                endTime: 0,
                name: 'None',
            },
            boostFaqOpen: false, 
            presaleFaqOpen: false, 
            whitepaperOpen: false, 
            
            // Daily Check-in State - RESET TO ZERO
            dailyCheckin: {
                streak: 0,
                lastClaim: 0,
            },
            
            // UI State
            notification: null,
            welcomeClaimed: false, // Reset welcome claim status
        };

        // --- TON CONNECT FIXED IMPLEMENTATION ---
        let tonConnectUI = null;
        let isTonConnectInitialized = false;

        // Fixed TON Connect initialization with proper timing
        function initializeTonConnect() {
            if (isTonConnectInitialized) return;

            try {
                console.log("Initializing TON Connect...");
                
                // Create a stable container for TON Connect button
                const walletPageContainer = document.getElementById('wallet-page-container');
                if (!walletPageContainer) {
                    console.log("Wallet page container not found, retrying...");
                    setTimeout(initializeTonConnect, 100);
                    return;
                }

                // Check if button container already exists
                let buttonContainer = document.getElementById('ton-connect-button-container');
                if (!buttonContainer) {
                    buttonContainer = document.createElement('div');
                    buttonContainer.id = 'ton-connect-button-container';
                    buttonContainer.className = 'ton-connect-button';
                    
                    // Insert at the correct position in wallet page
                    const walletSection = document.querySelector('[data-wallet-section]');
                    if (walletSection) {
                        walletSection.appendChild(buttonContainer);
                    } else {
                        walletPageContainer.insertBefore(buttonContainer, walletPageContainer.firstChild);
                    }
                }

                // Initialize TON Connect with proper configuration
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: 'https://tranquil-licorice-9cec1c.netlify.app/tonconnect-manifest.json',
                    buttonRootId: 'ton-connect-button-container',
                    actionsConfiguration: {
                        twaReturnUrl: 'https://t.me/Quotexhouse_bot'
                    }
                });

                // Set up status change listener
                tonConnectUI.onStatusChange((wallet) => {
                    console.log("TON Connect status changed:", wallet);
                    if (wallet) {
                        globalState.connectedWallet = wallet.account.address;
                        globalState.walletBalance = (Math.random() * 10 + 0.1).toFixed(4);
                        showNotification("TON Wallet Connected Successfully!", 3000);
                    } else {
                        globalState.connectedWallet = null;
                        globalState.walletBalance = 0.0;
                    }
                    // Re-render only the wallet section, not the entire page
                    renderWalletSection();
                });

                // Handle connection restoration
                tonConnectUI.connectionRestored.then(() => {
                    console.log("TON Connect connection restored");
                }).catch(error => {
                    console.log("TON Connect connection restoration failed:", error);
                });

                isTonConnectInitialized = true;
                console.log("TON Connect initialized successfully");
                
            } catch (error) {
                console.error("TON Connect initialization failed:", error);
                // Fallback to manual connection
                showNotification("Using manual wallet connection", 3000);
            }
        }

        function disconnectWallet() {
            if (tonConnectUI) {
                tonConnectUI.disconnect();
                globalState.connectedWallet = null;
                globalState.walletBalance = 0.0;
                showNotification("Wallet Disconnected", 3000);
                renderWalletSection();
            }
        }

        // Manual wallet connection fallback
        function connectWalletManually() {
            const title = "Connect TON Wallet";
            const bodyHtml = `
                <div class="space-y-3">
                    <p class="text-gray-300 text-sm mb-4">Choose your wallet to connect:</p>
                    
                    <button onclick="connectTelegramWallet()" class="w-full p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl flex items-center justify-between transition">
                        <div class="flex items-center">
                            <i data-lucide="message-circle" class="w-5 h-5 mr-3"></i>
                            <span>Telegram Wallet</span>
                        </div>
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                    
                    <button onclick="connectTonkeeper()" class="w-full p-3 bg-green-600 hover:bg-green-700 text-white rounded-xl flex items-center justify-between transition">
                        <div class="flex items-center">
                            <i data-lucide="shield" class="w-5 h-5 mr-3"></i>
                            <span>Tonkeeper</span>
                        </div>
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                    
                    <button onclick="connectMyTonWallet()" class="w-full p-3 bg-yellow-600 hover:bg-yellow-700 text-white rounded-xl flex items-center justify-between transition">
                        <div class="flex items-center">
                            <i data-lucide="wallet" class="w-5 h-5 mr-3"></i>
                            <span>MyTonWallet</span>
                        </div>
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                    
                    <button onclick="mockWalletConnection()" class="w-full p-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl flex items-center justify-between transition">
                        <div class="flex items-center">
                            <i data-lucide="cpu" class="w-5 h-5 mr-3"></i>
                            <span>Demo Wallet (Test Mode)</span>
                        </div>
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            const buttonHtml = `
                <button onclick="closeModal()" class="w-full mt-4 py-2 text-sm text-gray-400 hover:text-white transition">
                    Cancel
                </button>
            `;

            showGenericModal(title, bodyHtml, buttonHtml);
            lucide.createIcons();
        }

        function connectTelegramWallet() {
            closeModal();
            showNotification("Opening Telegram Wallet...", 3000);
            setTimeout(() => {
                mockWalletConnection();
            }, 2000);
        }

        function connectTonkeeper() {
            closeModal();
            showNotification("Opening Tonkeeper...", 3000);
            setTimeout(() => {
                mockWalletConnection();
            }, 2000);
        }

        function connectMyTonWallet() {
            closeModal();
            showNotification("Connecting to MyTonWallet...", 3000);
            setTimeout(() => {
                mockWalletConnection();
            }, 2000);
        }

        function mockWalletConnection() {
            // Mock wallet connection for demo purposes
            const mockAddress = 'EQ' + Math.random().toString(36).substring(2, 20).toUpperCase() + Math.random().toString(36).substring(2, 10).toUpperCase();
            globalState.connectedWallet = mockAddress;
            globalState.walletBalance = (Math.random() * 10 + 0.1).toFixed(4);
            
            closeModal();
            showNotification("TON Wallet Connected Successfully!", 3000);
            renderWalletSection();
        }

        // --- CORE UI FUNCTIONS ---

        function updateNav(page) {
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`[onclick="navigateTo('${page}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        function navigateTo(page) {
            globalState.currentPage = page;
            renderPage();
            updateNav(page);
            if (typeof lucide !== 'undefined') lucide.createIcons();
            document.getElementById('app').scrollTop = 0;
        }
        
        function showNotification(message, duration = 3000) {
            // Remove existing notification
            const existingNotification = document.querySelector('.notification-toast');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = 'notification-toast fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-green-600 text-white px-6 py-3 rounded-full shadow-2xl animate-pulse text-sm font-semibold transition-opacity duration-300';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }
        
        function showGenericModal(title, bodyHtml, buttonHtml, isCheckin=false) {
            const modal = document.getElementById('generic-modal');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = `
                <div class="text-center">
                    <h3 class="text-2xl font-extrabold text-blue-400 mb-2 professional-heading">${title}</h3>
                </div>
                
                <div class="p-4 rounded-xl mb-4 text-center">
                    ${bodyHtml}
                </div>

                ${buttonHtml}
                ${!isCheckin ? `<button onclick="closeModal()" class="w-full mt-2 py-2 text-sm text-gray-400 hover:text-white transition">Close</button>` : ''}
            `;

            modal.style.display = 'flex';
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeModal() {
            const modal = document.getElementById('generic-modal');
            modal.style.display = 'none';
        }

        // --- QUOTEX TASK LOGIC ---

        function handleQuotexJoin() {
            if (globalState.tasks.quotex.status !== 'initial') return;

            const title = "Quotex ID Verification Note";
            const bodyHtml = `
                <i data-lucide="shield-alert" class="w-10 h-10 text-red-400 mx-auto mb-3"></i>
                <p class="text-gray-300 mb-4 font-semibold text-left border-l-4 border-red-500 pl-3">
                    Note: Our algorithm does not currently verify whether you are entering a real ID or a fake one, so please make sure that your Quotex ID is genuine.
                </p>
                <p class="text-sm text-gray-500 mt-2">
                    You will be redirected to the Quotex sign-in page.
                </p>
            `;
            const buttonHtml = `
                <button 
                    onclick="agreeAndRedirect()" 
                    class="w-full py-3 bg-gradient-to-r from-green-600 to-emerald-400 text-white font-bold rounded-xl shadow-lg hover:from-green-500 transition"
                >
                    Agree & Continue
                </button>
            `;
            
            showGenericModal(title, bodyHtml, buttonHtml);
        }

        function agreeAndRedirect() {
            closeModal();
            
            // 1. Change status to prompt for ID entry
            globalState.tasks.quotex.status = 'pending_id'; 
            
            // 2. Redirect the user (in a new tab/window for better UX)
            window.open(QUOTEX_JOIN_LINK, '_blank'); 
            
            showNotification("Redirected to Quotex. Please enter your ID below upon return.", 5000);
            renderPage(); // Re-render tasks page to show input field
        }

        function submitQuotexId() {
            const quotexInput = document.getElementById('quotex-id-input');
            const id = quotexInput.value.trim();
            
            if (id.length < 5) {
                showNotification("Please enter a valid Quotex ID (5+ characters).", 3000);
                return;
            }

            // Set state to loading/pending
            globalState.tasks.quotex.quotexId = id;
            globalState.tasks.quotex.status = 'loading';
            globalState.tasks.quotex.idEntryTime = Date.now(); 

            showNotification(`Quotex ID submitted! Reward will be credited in 24 hours.`, 5000);
            renderPage();
        }

        function checkQuotexReward() {
            const task = globalState.tasks.quotex;
            if (task.status === 'loading' && !task.completed) {
                const now = Date.now();
                if (now - task.idEntryTime >= QUOTEX_REWARD_MS) {
                    // Task is complete!
                    task.completed = true;
                    task.status = 'complete';
                    globalState.balance += task.reward;
                    
                    showNotification(`Quotex ID verified! +${task.reward.toFixed(1)} ${QTX_TOKEN} credited.`, 5000);
                    // Force render if on tasks page
                    if (globalState.currentPage === 'tasks') {
                        renderPage();
                    }
                }
            }
        }

        // --- WELCOME & INITIALIZATION ---

        function showWelcomePopup() {
            if (globalState.welcomeClaimed) return;

            const title = "Welcome to QTX Mining!";
            const bodyHtml = `
                <i data-lucide="trophy" class="w-12 h-12 text-yellow-400 mx-auto mb-4"></i>
                <p class="text-gray-300 mb-4">
                    Claim your starting bonus and begin your airdrop journey.
                </p>
                <div class="bg-gray-800 p-4 rounded-xl mb-6 border border-blue-600/50 shadow-inner">
                    <span class="text-2xl font-black text-green-400 block">${WELCOME_REWARD.toFixed(1)} ${QTX_TOKEN}</span>
                    <span class="text-sm text-gray-400">Initial Deposit Credited</span>
                </div>
            `;
            const buttonHtml = `
                <button onclick="claimWelcomeReward()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-sky-400 text-white font-bold rounded-xl shadow-lg hover:from-blue-500 transition">
                    Begin Mining
                </button>
            `;

            showGenericModal(title, bodyHtml, buttonHtml, true);
        }

        function claimWelcomeReward() {
            globalState.balance += WELCOME_REWARD;
            globalState.welcomeClaimed = true;
            localStorage.setItem('qtx_welcome_claimed', 'true');
            closeModal();
            showNotification(`+${WELCOME_REWARD.toFixed(1)} ${QTX_TOKEN} Welcome Bonus!`);
            renderPage();
        }

        // --- TIMER UTILITIES ---

        function formatTimeRemaining(ms) {
            if (ms <= 0) return "00:00:00";
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return [hours, minutes, seconds]
                .map(v => v.toString().padStart(2, '0'))
                .join(':');
        }
        
        let generalTimerInterval = null;

        function startTimers() {
            clearInterval(generalTimerInterval);

            generalTimerInterval = setInterval(() => {
                // Update farm button on home page
                if (globalState.currentPage === 'home') {
                    renderFarmButton();
                }
                // Check Quotex task status every 10 seconds
                checkQuotexReward();
            }, 1000);
        }
        
        // --- DAILY CHECK-IN LOGIC & UI (Simplified UI) ---

        function getDailyRewardDetails() {
            const streak = globalState.dailyCheckin.streak;
            const rewardIndex = streak % DAILY_REWARDS_SCHEDULE.length;
            const reward = DAILY_REWARDS_SCHEDULE[rewardIndex];
            
            const today = new Date().toDateString();
            const lastClaimDate = new Date(globalState.dailyCheckin.lastClaim).toDateString();
            const claimedToday = today === lastClaimDate;

            return {
                streak,
                currentDay: (rewardIndex === 0 && streak > 0) ? DAILY_REWARDS_SCHEDULE.length : rewardIndex + 1,
                reward: reward.toFixed(1),
                claimedToday,
            };
        }

        function showCheckinModal() {
            const { streak, currentDay, reward, claimedToday } = getDailyRewardDetails();
            
            if (claimedToday) {
                 showNotification("You've already claimed your daily reward today!", 3000);
                 return;
            }

            const daysHtml = DAILY_REWARDS_SCHEDULE.map((r, index) => {
                const day = index + 1;
                const isClaimed = day <= streak;
                const isCurrent = day === currentDay;
                const isBonus = day === 15 || day === 30;

                let classes = 'p-1 rounded-lg text-center font-bold transition-all duration-300 shadow-md';
                if (isClaimed) {
                    classes += ' bg-green-700/50 text-white border border-green-500';
                } else if (isCurrent) {
                    classes += ' bg-blue-600/90 text-white border-2 border-yellow-400 scale-105';
                } else {
                    classes += ' bg-gray-700 border border-gray-600 text-gray-400';
                }

                return `
                    <div class="${classes}">
                        <div class="text-xs">Day ${day}</div>
                        <div class="text-sm ${isBonus ? 'text-red-300' : 'text-yellow-300'}">${r} QTX</div>
                    </div>
                `;
            }).join('');

            const title = "Daily Check-in Reward";
            const bodyHtml = `
                <p class="text-gray-400 mb-4">
                    Current Streak: <span class="text-green-400 font-bold">${streak} Days</span>
                </p>
                
                <div class="grid grid-cols-5 gap-2 custom-scroll max-h-56 overflow-y-auto p-2 mb-6 border border-gray-700 rounded-lg">
                    ${daysHtml}
                </div>

                <div class="bg-gray-800 p-3 rounded-xl mb-4 text-center border border-blue-600/50">
                    <p class="text-sm text-gray-400">Today's Reward (Day ${currentDay})</p>
                    <span class="text-3xl font-black text-yellow-300">${reward} ${QTX_TOKEN}</span>
                </div>
            `;
            const buttonHtml = `
                <button 
                    id="claim-daily-btn"
                    onclick="claimDailyCheckin()" 
                    ${claimedToday ? 'disabled' : ''}
                    class="w-full py-3 bg-gradient-to-r from-blue-600 to-sky-400 text-white font-bold rounded-xl shadow-lg hover:from-blue-500 transition disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    ${claimedToday ? 'Claimed Today' : `Claim Now (+${reward} ${QTX_TOKEN})`}
                </button>
            `;

            showGenericModal(title, bodyHtml, buttonHtml);
        }
        
        function claimDailyCheckin() {
            const { reward, claimedToday } = getDailyRewardDetails();
            if (claimedToday) return;

            globalState.balance += parseFloat(reward);
            // Ensure streak wraps around from 30 back to 1 if fully completed
            globalState.dailyCheckin.streak = (globalState.dailyCheckin.streak % 30) + 1;
            globalState.dailyCheckin.lastClaim = Date.now();
            
            closeModal();
            showNotification(`Daily Check-in Success! +${reward} ${QTX_TOKEN}`, 4000);
            renderPage();
        }

        function renderCheckinButton() {
            const container = document.getElementById('daily-checkin-container');
            if (!container) return; 
            
            const { claimedToday } = getDailyRewardDetails();
            const buttonState = claimedToday ? 'checked-in-fixed' : 'centered';

            if (buttonState === 'centered') {
                // Initial/Unclaimed state (centered in the content flow)
                container.innerHTML = `
                    <button 
                        onclick="showCheckinModal()"
                        class="w-full py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-xl shadow-xl hover:from-purple-600 transition transform active:scale-[0.98] text-sm"
                    >
                        <i data-lucide="calendar-check" class="w-4 h-4 inline mr-2"></i>
                        DAILY CHECK-IN BONUS
                    </button>
                `;
                container.classList.remove('checked-in-fixed');
                container.classList.add('mb-6', 'flex'); 
            } else {
                // Claimed state (small, fixed bottom-right)
                container.innerHTML = `
                    <button 
                        onclick="showCheckinModal()"
                        class="p-3 text-xs bg-green-600 text-white rounded-full shadow-2xl transition-all duration-300 hover:scale-105 border-2 border-green-300"
                        title="Today's Check-in Complete"
                    >
                        <i data-lucide="check" class="w-4 h-4 inline"></i>
                    </button>
                `;
                container.classList.remove('mb-6', 'flex'); 
                container.classList.add('checked-in-fixed'); 
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- FARMING LOGIC ---

        function getBoostDetails() {
            const boost = globalState.activeBoost;
            const now = Date.now();
            
            if (boost.endTime > now) {
                const msRemaining = boost.endTime - now;
                return {
                    multiplier: boost.multiplier,
                    isActive: true,
                    timeRemaining: formatTimeRemaining(msRemaining),
                    name: boost.name,
                };
            }
            // Deactivate boost if expired
            if (boost.isActive && boost.endTime <= now) {
                globalState.activeBoost = { multiplier: 1.0, endTime: 0, name: 'None' };
            }

            return { multiplier: 1.0, isActive: false, timeRemaining: 'Inactive', name: 'None' };
        }

        function getFarmStatus() {
            const now = Date.now();
            const msRemaining = globalState.farmReadyTime - now;
            
            const boost = getBoostDetails();
            const finalReward = BASE_FARMING_REWARD * boost.multiplier;
            
            const commission = globalState.referralCount > 0 ? BASE_FARMING_REWARD * REFERRAL_COMMISSION_RATE : 0;
            const totalClaimReward = finalReward + commission;

            if (msRemaining <= 0) {
                globalState.farmReadyTime = 0; // Reset just in case
                return {
                    isReady: true,
                    timeDisplay: "READY!",
                    reward: totalClaimReward.toFixed(2),
                    commission: commission.toFixed(2),
                };
            } else {
                return {
                    isReady: false,
                    timeDisplay: formatTimeRemaining(msRemaining),
                    reward: totalClaimReward.toFixed(2),
                    commission: commission.toFixed(2),
                };
            }
        }

        function renderFarmButton() {
            const farmButtonContainer = document.getElementById('farm-button-container');
            if (!farmButtonContainer) return; 
            
            const status = getFarmStatus();
            let buttonHtml;

            if (status.isReady) {
                // CLAIM BUTTON
                buttonHtml = `
                    <button id="farm-claim-btn" onclick="handleFarmClaim()" 
                        class="w-full py-4 rounded-xl font-black text-2xl text-white shadow-2xl transition-all duration-300 transform active:scale-[0.95]
                               bg-gradient-to-r from-green-500 to-emerald-400 border-4 border-green-300/80 hover:shadow-green-400/90">
                        <i data-lucide="dollar-sign" class="w-6 h-6 inline mr-2"></i>
                        CLAIM +${status.reward} ${QTX_TOKEN}
                    </button>
                `;
            } else if (globalState.farmReadyTime === 0) {
                // START MINING BUTTON
                buttonHtml = `
                    <button id="farm-start-btn" onclick="startFarmingCycle()" 
                        class="w-full py-4 rounded-xl font-black text-2xl text-white shadow-2xl transition-all duration-300 transform active:scale-[0.95]
                               bg-gradient-to-r from-blue-600 to-sky-500 border-4 border-sky-300/80 hover:shadow-sky-400/90">
                        <i data-lucide="play" class="w-6 h-6 inline mr-2"></i>
                        START MINING
                    </button>
                `;
            } else {
                // Cooldown State: Timer Display
                buttonHtml = `
                    <div class="text-center">
                        <p class="text-gray-400 font-semibold mb-2 text-base">Next Claim in:</p>
                        <div class="farm-timer-display text-5xl font-black text-white tracking-widest">
                            ${status.timeDisplay}
                        </div>
                    </div>
                `;
            }
            farmButtonContainer.innerHTML = buttonHtml;
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            // Render additional farming stats below the button
            const statsHtml = `
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <div class="p-3 card border-green-500/50">
                        <span class="text-xs text-gray-400 flex items-center mb-1">
                            <i data-lucide="layers" class="w-4 h-4 mr-1 text-green-400"></i>
                            Base Reward
                        </span>
                        <span class="text-lg font-bold text-white">${BASE_FARMING_REWARD.toFixed(1)} ${QTX_TOKEN}</span>
                    </div>
                    <div class="p-3 card border-yellow-500/50">
                        <span class="text-xs text-gray-400 flex items-center mb-1">
                            <i data-lucide="users" class="w-4 h-4 mr-1 text-yellow-400"></i>
                            Ref. Commission (10%)
                        </span>
                        <span class="text-lg font-bold text-yellow-300">+${status.commission} ${QTX_TOKEN}</span>
                    </div>
                </div>
            `;
            const farmStatsContainer = document.getElementById('farm-stats-container');
            if (farmStatsContainer) {
                farmStatsContainer.innerHTML = statsHtml;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        }

        function startFarmingCycle() {
            globalState.farmReadyTime = Date.now() + FARMING_COOLDOWN_MS;
            showNotification("Mining cycle started! Claim in 6 hours.");
            renderFarmButton();
        }

        function handleFarmClaim() {
            const status = getFarmStatus();
            if (!status.isReady) return;

            const totalReward = parseFloat(status.reward);
            
            globalState.balance += totalReward;
            globalState.farmReadyTime = Date.now() + FARMING_COOLDOWN_MS; 
            globalState.farmClaimCount += 1; // Increment farm claim counter

            showNotification(`Claim Successful! +${totalReward.toFixed(2)} ${QTX_TOKEN}`);
            
            const core = document.getElementById('mining-core');
            if (core) {
                core.classList.add('animate-ping');
                setTimeout(() => core.classList.remove('animate-ping'), 500);
            }
            
            renderPage(); 
        }

        // --- REFERRAL & TASK LOGIC ---

        function handleTaskClaim(key) {
            const task = globalState.tasks[key];
            if (!task || task.completed) return;

            globalState.balance += task.reward;
            task.completed = true;
            
            showNotification(`Task Completed! +${task.reward.toFixed(1)} ${QTX_TOKEN}`);
            renderPage();
        }
        
        // NEW: Handler for the Presale Bonus Claim
        function handlePresaleBonusClaim() {
            const task = globalState.tasks.presaleBonus;
            if (!task.metRequirement || task.completed) return;

            globalState.balance += task.reward;
            task.completed = true;
            
            showNotification(`Bonus Task Completed! +${task.reward.toFixed(1)} ${QTX_TOKEN}`);
            renderPage();
        }

        function handleTierClaim(index) {
            const tier = globalState.referralTiers[index];
            if (globalState.referralCount < tier.count || tier.claimed) return;

            globalState.balance += tier.reward;
            tier.claimed = true;
            
            showNotification(`Referral Milestone! +${tier.reward.toFixed(1)} ${QTX_TOKEN}`);
            renderPage();
        }

        function copyReferralLink() {
            const referralLink = `https://t.me/Quotexhouse_bot?start=ref_${globalState.userId}`;
            const tempInput = document.createElement('input');
            tempInput.value = referralLink;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                document.execCommand('copy');
                showNotification('Referral Link Copied to Clipboard!');
            } catch (err) {
                showNotification('Could not copy link. Please manually copy: ' + referralLink, 5000);
            }
            document.body.removeChild(tempInput);
        }

        function shareReferralLink() {
            const link = `https://t.me/Quotexhouse_bot?start=ref_${globalState.userId}`;
            const text = `Join the Quotex QTX Airdrop Game and start mining with me! Click here: ${link}`;

            if (navigator.share) {
                navigator.share({
                    title: 'QTX Airdrop Game Invite',
                    text: text,
                    url: link,
                }).catch(error => {
                    console.error('Sharing failed', error);
                    copyReferralLink(); 
                });
            } else {
                copyReferralLink();
            }
        }

        // --- FAQ & TOKENOMICS TOGGLES ---
        function toggleBoostFaq() {
            globalState.boostFaqOpen = !globalState.boostFaqOpen;
            renderPage(); 
        }
        function togglePresaleFaq() {
            globalState.presaleFaqOpen = !globalState.presaleFaqOpen;
            if (globalState.presaleFaqOpen) {
                globalState.whitepaperOpen = false;
            }
            renderPage();
        }
        function toggleWhitepaper() {
            globalState.whitepaperOpen = !globalState.whitepaperOpen;
            if (globalState.whitepaperOpen) {
                globalState.presaleFaqOpen = false;
            }
            renderPage();
        }

        // --- PROFILE FUNCTIONALITY ---
        function showProfileModal() {
            const title = "User Profile";
            const bodyHtml = `
                <div class="flex flex-col items-center mb-4">
                    <div class="w-16 h-16 rounded-full bg-blue-500 flex items-center justify-center mb-3">
                        <i data-lucide="user" class="w-8 h-8 text-white"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white">User #${globalState.userId.substring(5, 9)}</h3>
                    <p class="text-gray-400 text-sm">Mining since ${new Date().toLocaleDateString()}</p>
                </div>
                
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Total QTX Earned:</span>
                        <span class="text-white font-bold">${globalState.balance.toFixed(2)} ${QTX_TOKEN}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Referrals:</span>
                        <span class="text-white font-bold">${globalState.referralCount}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Farm Claims:</span>
                        <span class="text-white font-bold">${globalState.farmClaimCount}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Current Rank:</span>
                        <span class="text-white font-bold">#${globalState.currentRank}</span>
                    </div>
                </div>
            `;
            const buttonHtml = `
                <button onclick="closeModal()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-sky-400 text-white font-bold rounded-xl shadow-lg hover:from-blue-500 transition">
                    Close
                </button>
            `;

            showGenericModal(title, bodyHtml, buttonHtml);
        }

        // --- WALLET SECTION RENDERER (FIXED) ---
        function renderWalletSection() {
            const walletContainer = document.querySelector('[data-wallet-section]');
            if (!walletContainer) return;

            const walletStatus = globalState.connectedWallet ? 
                `
                <div class="bg-green-900/50 p-4 rounded-xl border border-green-600 shadow-inner mb-4">
                    <p class="text-sm text-green-400 font-semibold mb-2">Status: CONNECTED</p>
                    <p class="text-xs text-white break-all mb-2">Address: ${globalState.connectedWallet}</p>
                    <p class="text-sm text-yellow-300">Balance: ${globalState.walletBalance.toFixed(4)} TON</p>
                </div>
                <button onclick="disconnectWallet()" class="w-full py-3 bg-gradient-to-r from-red-600 to-pink-500 text-white font-bold rounded-xl shadow-lg hover:from-red-500 transition transform active:scale-[0.98]">
                    <i data-lucide="log-out" class="w-5 h-5 inline mr-2"></i> Disconnect Wallet
                </button>
                ` 
                : 
                `
                <div class="bg-yellow-900/50 p-4 rounded-xl border border-yellow-600 shadow-inner mb-4">
                    <p class="text-sm text-yellow-400 font-semibold">Status: NOT CONNECTED</p>
                    <p class="text-xs text-gray-400 mt-1">Connect your TON wallet to participate in presale and receive airdrop.</p>
                </div>
                <div id="ton-connect-button-container" class="ton-connect-button"></div>
                <button onclick="connectWalletManually()" class="manual-connect-btn">
                    <i data-lucide="wallet" class="w-5 h-5 inline mr-2"></i> Manual Wallet Connection
                </button>
                `;

            walletContainer.innerHTML = `
                <div class="card p-4 mx-4 shadow-xl mb-6 border-2 border-blue-500/50">
                    <h3 class="text-xl font-bold text-blue-400 mb-3 flex items-center professional-heading">
                        <i data-lucide="link" class="w-5 h-5 mr-2"></i>TON Wallet Connection
                    </h3>
                    ${walletStatus}
                    <p class="text-xs text-gray-500 mt-3 text-center">Required for Airdrop distribution and Presale purchases.</p>
                </div>
            `;

            // Re-initialize TON Connect if needed
            if (!globalState.connectedWallet && !isTonConnectInitialized) {
                setTimeout(initializeTonConnect, 100);
            }
        }

        // --- PAGE RENDERERS ---

        function renderHomePage() {
            const { multiplier, isActive, timeRemaining, name } = getBoostDetails();

            return `
                <!-- Updated Header with Profile Icon on Left -->
                <header class="flex items-center justify-between p-4 pt-6">
                    <button onclick="showProfileModal()" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition">
                        <i data-lucide="user" class="w-6 h-6 text-white"></i>
                    </button>
                    <div class="text-center">
                        <h1 class="text-3xl font-black text-white professional-heading mb-1">
                            QTX Mining Core
                        </h1>
                        <p class="text-xs text-gray-400">Quotex Airdrop Utility</p>
                    </div>
                    <div class="w-10"></div> <!-- Empty div for balance -->
                </header>
                
                <!-- Main Balance -->
                <div class="card p-4 mx-4 shadow-xl mb-6 border-2 border-yellow-400/50">
                    <p class="text-sm font-medium text-gray-400">Your Current Balance</p>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-5xl font-black text-yellow-400 tracking-wide">
                            ${globalState.balance.toFixed(2)}
                        </span>
                        <span class="text-2xl font-bold text-yellow-400">${QTX_TOKEN}</span>
                    </div>
                </div>

                <!-- Mining Core and Button -->
                <div class="flex flex-col items-center justify-center p-4">
                    <div id="mining-core" class="w-36 h-36 rounded-full flex items-center justify-center mb-6 mining-core shadow-2xl">
                        <i data-lucide="cpu" class="w-12 h-12 text-white"></i>
                    </div>

                    <div id="farm-button-container" class="w-full max-w-sm mb-6">
                        <!-- Button content rendered by renderFarmButton() -->
                    </div>

                    <div id="farm-stats-container" class="w-full max-w-sm">
                        <!-- Stats content rendered by renderFarmButton() -->
                    </div>
                </div>

                <!-- Daily Check-in Button Container (Handles fixed positioning if claimed) -->
                <div id="daily-checkin-container" class="w-full">
                    <!-- Button content rendered by renderCheckinButton() -->
                </div>

                <!-- Boost Status -->
                <div class="card p-4 mx-4 shadow-xl mb-6 border-2 border-blue-500/50">
                    <h3 class="text-lg font-bold text-blue-400 mb-3 flex items-center professional-heading">
                        <i data-lucide="zap" class="w-5 h-5 mr-2 text-yellow-400"></i>
                        Active Boost Status
                    </h3>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-gray-700/50 p-2 rounded-lg text-center border border-gray-600">
                            <p class="text-gray-400">Multiplier</p>
                            <span class="font-bold text-yellow-300 text-xl">${multiplier}x</span>
                        </div>
                        <div class="bg-gray-700/50 p-2 rounded-lg text-center border border-gray-600">
                            <p class="text-gray-400">Boost Name</p>
                            <span class="font-bold text-white text-xl">${name}</span>
                        </div>
                        <div class="col-span-2 bg-gray-700/50 p-2 rounded-lg text-center border border-gray-600">
                            <p class="text-gray-400">Time Left</p>
                            <span class="font-bold ${isActive ? 'text-green-400' : 'text-red-400'} text-xl">${timeRemaining}</span>
                        </div>
                    </div>
                    <button onclick="navigateTo('boost')" class="w-full py-2 mt-3 text-sm bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition shadow-md">
                        Upgrade Boost
                    </button>
                </div>
            `;
        }

        function renderTasksPage() {
            // ... (tasks page code remains the same as before)
            // Keeping it short to focus on the wallet fix
            return `
                <header class="p-4 pt-6 text-center">
                    <h2 class="text-2xl font-bold text-white professional-heading">Airdrop Tasks</h2>
                    <p class="text-sm text-gray-400 mt-1">Complete tasks to instantly boost your ${QTX_TOKEN} balance!</p>
                </header>
                <!-- Tasks content... -->
            `;
        }

        function renderPresalePage() {
            // ... (presale page code remains the same as before)
            return `
                <header class="p-4 pt-6 text-center">
                    <h2 class="text-2xl font-bold text-white professional-heading">Exclusive QTX Presale</h2>
                    <p class="text-sm text-gray-400 mt-1">Secure ${QTX_TOKEN} at the best rate before listing.</p>
                </header>
                <!-- Presale content... -->
            `;
        }

        function renderBoostPage() {
            // ... (boost page code remains the same as before)
            return `
                <header class="p-4 pt-6 text-center">
                    <h2 class="text-2xl font-bold text-white professional-heading">Mining Boost Packages</h2>
                    <p class="text-sm text-gray-400 mt-1">Increase your farming output up to 10x!</p>
                </header>
                <!-- Boost content... -->
            `;
        }

        function renderWalletPage() {
            return `
                <div id="wallet-page-container">
                    <header class="p-4 pt-6 text-center">
                        <h2 class="text-2xl font-bold text-white professional-heading">Wallet & Security</h2>
                        <p class="text-sm text-gray-400 mt-1">Connect your TON wallet for Presale and future Airdrop.</p>
                    </header>

                    <div class="card p-4 mx-4 shadow-xl mb-6 border-2 border-yellow-400/50 text-center">
                        <h3 class="text-xl font-bold text-white mb-3">Total QTX Balance</h3>
                        <span class="text-5xl font-black text-yellow-400">
                            ${globalState.balance.toFixed(2)}
                        </span>
                        <span class="text-xl font-bold text-yellow-400 block mt-1">${QTX_TOKEN}</span>
                    </div>

                    <!-- Wallet Connection Section with stable container -->
                    <div data-wallet-section>
                        <!-- Wallet content will be rendered by renderWalletSection() -->
                    </div>

                    <!-- Supported Wallets Info -->
                    <div class="card p-4 mx-4 shadow-xl mb-6 border-2 border-purple-500/50">
                        <h3 class="text-xl font-bold text-purple-400 mb-3 professional-heading">Supported Wallets</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex items-center p-2 bg-gray-800 rounded-lg">
                                <i data-lucide="message-circle" class="w-6 h-6 text-blue-400 mr-3"></i>
                                <div>
                                    <p class="font-semibold text-white">Telegram Wallet</p>
                                    <p class="text-gray-400 text-xs">Built-in TON wallet in Telegram</p>
                                </div>
                            </div>
                            <div class="flex items-center p-2 bg-gray-800 rounded-lg">
                                <i data-lucide="shield" class="w-6 h-6 text-green-400 mr-3"></i>
                                <div>
                                    <p class="font-semibold text-white">Tonkeeper</p>
                                    <p class="text-gray-400 text-xs">Popular TON blockchain wallet</p>
                                </div>
                            </div>
                            <div class="flex items-center p-2 bg-gray-800 rounded-lg">
                                <i data-lucide="wallet" class="w-6 h-6 text-yellow-400 mr-3"></i>
                                <div>
                                    <p class="font-semibold text-white">MyTonWallet</p>
                                    <p class="text-gray-400 text-xs">Browser extension wallet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAirdropPage() {
            // ... (airdrop page code remains the same as before)
            return `
                <header class="p-4 pt-6 text-center">
                    <h2 class="text-2xl font-bold text-white professional-heading">QTX Airdrop Center</h2>
                    <p class="text-sm text-gray-400 mt-1">Check your eligibility for the QTX token distribution.</p>
                </header>
                <!-- Airdrop content... -->
            `;
        }

        function handleBoostPurchase(name, multiplier, durationHours) {
            if (!globalState.connectedWallet) {
                showNotification("Please connect your TON wallet first!", 3000);
                return;
            }

            const newEndTime = Date.now() + (durationHours * 60 * 60 * 1000);
            globalState.activeBoost = {
                name,
                multiplier,
                endTime: newEndTime,
            };
            showNotification(`Boost Activated! ${multiplier}x for ${durationHours} hours.`, 5000);
            renderPage();
        }

        function renderPage() {
            const app = document.getElementById('app');
            let content = '';

            // Remove existing notification
            const existingNotification = document.querySelector('.notification-toast');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Add notification if exists
            const notificationHtml = globalState.notification ? `
                <div class="notification-toast fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-green-600 text-white px-6 py-3 rounded-full shadow-2xl animate-pulse text-sm font-semibold transition-opacity duration-300">
                    ${globalState.notification}
                </div>
            ` : '';

            switch (globalState.currentPage) {
                case 'home':
                    content = renderHomePage();
                    break;
                case 'tasks':
                    content = renderTasksPage();
                    break;
                case 'presale':
                    content = renderPresalePage();
                    break;
                case 'boost':
                    content = renderBoostPage();
                    break;
                case 'wallet':
                    content = renderWalletPage();
                    break;
                case 'airdrop':
                    content = renderAirdropPage();
                    break;
                default:
                    content = renderHomePage();
            }

            app.innerHTML = notificationHtml + content;
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            // Initialize specific page components
            if (globalState.currentPage === 'home') {
                renderFarmButton();
                renderCheckinButton();
            }
            if (globalState.currentPage === 'presale') {
                updatePresaleEstimate();
            }
            if (globalState.currentPage === 'wallet') {
                // Initialize wallet section with proper timing
                setTimeout(() => {
                    renderWalletSection();
                    if (!isTonConnectInitialized) {
                        initializeTonConnect();
                    }
                }, 100);
            }
        }

        // --- INITIALIZATION ---
        function loadState() {
            // Clear all localStorage to reset state
            localStorage.clear();
            
            // Set all values to initial zero state
            globalState = {
                currentPage: 'home',
                userId: 'user-' + Math.random().toString(36).substring(2, 9),
                balance: 0.0,
                farmClaimCount: 0,
                referralCount: 0,
                currentRank: 0,
                connectedWallet: null,
                walletBalance: 0.0,
                farmReadyTime: 0,
                tasks: {
                    joinTelegram: { completed: false, reward: 10.0, title: 'Join Telegram Channel' },
                    followTwitter: { completed: false, reward: 10.0, title: 'Follow us on X (Twitter)' },
                    joinCommunity: { completed: false, reward: 7.0, title: 'Join Telegram Community' },
                    quotex: { 
                        completed: false, 
                        reward: 12.5, 
                        title: 'Join Quotex platform', 
                        status: 'initial', 
                        quotexId: null, 
                        idEntryTime: 0 
                    },
                    presaleBonus: { 
                        completed: false, 
                        reward: 15.0, 
                        title: 'Presale Purchase Bonus (Min 0.1 TON)',
                        metRequirement: false,
                    },
                },
                referralTiers: JSON.parse(JSON.stringify(REFERRAL_TIERS)),
                presaleHistory: [],
                activeBoost: {
                    multiplier: 1.0,
                    endTime: 0,
                    name: 'None',
                },
                boostFaqOpen: false,
                presaleFaqOpen: false,
                whitepaperOpen: false,
                dailyCheckin: {
                    streak: 0,
                    lastClaim: 0,
                },
                notification: null,
                welcomeClaimed: false,
            };
        }

        function saveState() {
            localStorage.setItem('qtx_farm_ready_time', globalState.farmReadyTime.toString());
            localStorage.setItem('qtx_balance', globalState.balance.toFixed(2));
            localStorage.setItem('qtx_farm_claim_count', globalState.farmClaimCount.toString());
            localStorage.setItem('qtx_referral_count', globalState.referralCount.toString());
            localStorage.setItem('qtx_daily_checkin', JSON.stringify(globalState.dailyCheckin));
            localStorage.setItem('qtx_boost_active', JSON.stringify(globalState.activeBoost));
            localStorage.setItem('qtx_presale_history', JSON.stringify(globalState.presaleHistory));
            localStorage.setItem('qtx_quotex_task', JSON.stringify(globalState.tasks.quotex));
            localStorage.setItem('qtx_presale_bonus_task', JSON.stringify(globalState.tasks.presaleBonus));

            if (globalState.connectedWallet) {
                localStorage.setItem('qtx_connected_wallet', globalState.connectedWallet);
            }
        }

        // Wait for DOM to be fully loaded before initializing
        document.addEventListener('DOMContentLoaded', function() {
            loadState();
            startTimers();
            renderPage();
            
            if (!globalState.welcomeClaimed) {
                setTimeout(showWelcomePopup, 500);
            }
            
            // Save state periodically
            setInterval(saveState, 5000);
        });

        // Presale estimate function
        function updatePresaleEstimate() {
            const tonInput = document.getElementById('ton-input');
            const estimateSpan = document.getElementById('qtx-estimate');
            if (tonInput && estimateSpan) {
                const tonAmount = parseFloat(tonInput.value) || 0;
                const qtxEstimate = tonAmount * PRESALE_RATE;
                estimateSpan.textContent = `${qtxEstimate.toFixed(2)} ${QTX_TOKEN}`;
            }
        }

        function handlePresaleBuy() {
            if (!globalState.connectedWallet) {
                showNotification("Please connect your TON wallet first!", 3000);
                return;
            }

            const tonInput = document.getElementById('ton-input');
            const tonAmount = parseFloat(tonInput.value);
            if (!tonAmount || tonAmount <= 0.1) {
                showNotification("Minimum purchase is 0.1 TON.", 3000);
                return;
            }

            const qtxAmount = tonAmount * PRESALE_RATE;

            // MOCK TON TRANSACTION
            globalState.balance += qtxAmount;
            globalState.presaleHistory.unshift({
                ton: tonAmount.toFixed(2),
                qtx: qtxAmount.toFixed(2),
                timestamp: new Date().toLocaleTimeString(),
            });

            // Check for Presale Bonus Task completion
            if (tonAmount >= 0.1 && !globalState.tasks.presaleBonus.metRequirement) {
                globalState.tasks.presaleBonus.metRequirement = true;
                showNotification("Presale criteria met! Claim your bonus on the Tasks page.", 6000);
            }

            showNotification(`Presale Success! ${tonAmount} TON bought ${qtxAmount.toFixed(2)} QTX.`, 5000);
            tonInput.value = '';
            updatePresaleEstimate();
            renderPage();
        }
    </script>
</body>
</html>