<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotex QTX Airdrop Game</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- TON Connect UI -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        /* Define Deep Blue & Green Professional Colors */
        :root {
            --deep-blue: #0d1930;
            --dark-blue: #152642;
            --medium-blue: #1e3a5f;
            --accent-blue: #2d5a9a;
            --light-blue: #4a7fc9;
            --deep-green: #1a472a;
            --medium-green: #2e7d32;
            --accent-green: #4caf50;
            --light-green: #80e27e;
            --text-color: #e2e8f0;
        }

        body {
            background: linear-gradient(135deg, var(--deep-blue) 0%, var(--dark-blue) 100%);
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
            user-select: none;
            min-height: 100vh;
        }
        
        /* --- General Component Styling --- */
        .card {
            background: linear-gradient(145deg, var(--dark-blue) 0%, var(--medium-blue) 100%);
            border: 1px solid var(--accent-blue);
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-green), var(--light-blue));
        }

        .professional-heading {
            color: var(--light-blue);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        .gradient-text {
            background: linear-gradient(90deg, var(--accent-green), var(--light-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* --- Navigation Bar --- */
        .nav-button {
            transition: all 0.2s;
            position: relative;
            color: #94a3b8;
        }
        .nav-button.active {
            color: var(--accent-green);
            transform: scale(1.05);
            font-weight: 600;
        }
        .nav-button.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background-color: var(--accent-green);
            border-radius: 50%;
        }

        /* --- Home Page Specifics --- */
        .mining-core {
            border: 4px solid var(--accent-green);
            background: radial-gradient(circle, rgba(76, 175, 80, 0.3) 0%, rgba(76, 175, 80, 0.1) 70%);
            box-shadow: 0 0 40px rgba(76, 175, 80, 0.7);
            position: relative;
            backdrop-filter: blur(5px);
        }

        .mining-core::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            background: conic-gradient(
                var(--accent-green),
                var(--light-blue),
                var(--accent-green)
            );
            z-index: -1;
            animation: rotate 3s linear infinite;
            opacity: 0.7;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* NEW STYLISH TIMER DESIGN */
        .farm-timer-display {
            background: linear-gradient(145deg, var(--deep-blue) 0%, var(--dark-blue) 100%);
            border: 2px solid var(--accent-green);
            padding: 1rem;
            border-radius: 1.5rem;
            font-family: 'Courier New', monospace; 
            letter-spacing: 3px;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5), inset 0 0 10px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .farm-timer-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-green), var(--light-blue));
        }

        .timer-digits {
            font-size: 2.5rem;
            font-weight: 900;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.7);
            color: var(--accent-green);
            line-height: 1;
        }

        .timer-label {
            font-size: 0.8rem;
            color: var(--text-color);
            letter-spacing: 1px;
            margin-top: 0.5rem;
        }

        /* NEW STYLISH BALANCE DISPLAY */
        .balance-display {
            background: linear-gradient(145deg, var(--deep-green) 0%, var(--medium-green) 100%);
            border: 2px solid var(--accent-green);
            box-shadow: 0 0 25px rgba(76, 175, 80, 0.6);
            position: relative;
            overflow: hidden;
            padding: 1.5rem;
            border-radius: 1.5rem;
        }

        .balance-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-green), var(--light-blue));
        }

        .balance-amount {
            font-size: 3.5rem;
            font-weight: 900;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            color: #FFD700;
            line-height: 1;
        }

        .balance-label {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .balance-token {
            font-size: 1.8rem;
            font-weight: 700;
            color: #FFD700;
            margin-top: 0.5rem;
        }

        /* --- Daily Check-in Button Fixed Position (RESIZED) --- */
        .checked-in-fixed {
            position: fixed;
            bottom: calc(4.5rem + 15px); 
            right: 15px;
            z-index: 40;
            transition: transform 0.3s ease-in-out, background-color 0.3s;
            width: 50px;
            height: 50px;
        }
        
        /* --- Boost Package Styling --- */
        .boost-package {
            background: linear-gradient(145deg, var(--medium-blue) 0%, var(--accent-blue) 100%);
            border: 2px solid var(--accent-green);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .boost-package::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-green), var(--light-blue));
        }

        /* TON Connect Button Styling */
        .ton-connect-button {
            width: 100%;
            margin-bottom: 1rem;
        }

        /* Custom scrollbar for better aesthetics */
        .custom-scroll {
            overflow-y: auto;
        }
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: var(--accent-green);
            border-radius: 2px;
        }

        /* Glowing effect for important buttons */
        .glow-button {
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.7);
            transition: all 0.3s ease;
        }

        .glow-button:hover {
            box-shadow: 0 0 25px rgba(76, 175, 80, 0.9);
        }

        /* Gradient backgrounds for sections */
        .gradient-section {
            background: linear-gradient(145deg, var(--deep-blue) 0%, var(--dark-blue) 100%);
            border: 1px solid var(--accent-blue);
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        /* Task card styling */
        .task-card {
            background: linear-gradient(145deg, var(--dark-blue) 0%, var(--medium-blue) 100%);
            border: 1px solid var(--accent-blue);
            border-radius: 1.5rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        }

        .task-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-green), var(--light-blue));
        }

        /* Progress bar styling */
        .progress-bar {
            background: linear-gradient(90deg, var(--accent-green), var(--light-blue));
            border-radius: 10px;
            height: 8px;
        }

        /* Notification styling */
        .notification {
            background: linear-gradient(90deg, var(--deep-green) 0%, var(--medium-green) 100%);
            border: 1px solid var(--accent-green);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.7);
        }

        /* Home page header styling */
        .home-header {
            background: linear-gradient(145deg, var(--dark-blue) 0%, var(--medium-blue) 100%);
            border-radius: 0 0 2rem 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        .home-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-green), var(--light-blue));
        }

        /* Tasks page header styling */
        .tasks-header {
            background: linear-gradient(145deg, var(--dark-blue) 0%, var(--medium-blue) 100%);
            border-radius: 0 0 2rem 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        .tasks-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-green), var(--light-blue));
        }

        /* Section divider */
        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
            margin: 1.5rem 0;
        }

        /* Floating action button */
        .floating-action {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .floating-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        /* Animated background */
        .animated-bg {
            position: relative;
            overflow: hidden;
        }

        .animated-bg::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(76, 175, 80, 0.1) 0%, transparent 70%);
            animation: pulse 8s infinite linear;
            z-index: 0;
        }

        @keyframes pulse {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-item {
            background: rgba(30, 58, 95, 0.5);
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--accent-blue);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* NEW WALLET PAGE STYLING */
        .wallet-card {
            background: linear-gradient(145deg, var(--dark-blue) 0%, var(--medium-blue) 100%);
            border: 1px solid var(--accent-blue);
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .wallet-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-green), var(--light-blue));
        }

        .wallet-status-connected {
            background: linear-gradient(145deg, var(--deep-green) 0%, var(--medium-green) 100%);
            border: 1px solid var(--accent-green);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }

        .wallet-status-disconnected {
            background: linear-gradient(145deg, #5a3c1c 0%, #8b5a2b 100%);
            border: 1px solid #d4a574;
            box-shadow: 0 0 15px rgba(212, 165, 116, 0.5);
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--accent-blue);
            word-break: break-all;
        }

        .wallet-icon {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.8rem;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }

        .wallet-icon-telegram {
            background: linear-gradient(145deg, #229ED9 0%, #1E8BC3 100%);
        }

        .wallet-icon-tonkeeper {
            background: linear-gradient(145deg, #45aaf2 0%, #2d98da 100%);
        }

        .wallet-icon-mytonwallet {
            background: linear-gradient(145deg, #f7b731 0%, #e6a227 100%);
        }
    </style>
</head>
<body>

    <!-- Main App Container -->
    <div id="app" class="min-h-screen pb-20 max-w-md mx-auto relative custom-scroll">
        <!-- Content will be rendered here -->
    </div>

    <!-- Generic Full-Screen Modal (Used for Quotex Warning and Check-in) -->
    <div id="generic-modal" class="fixed inset-0 bg-gray-900/90 hidden items-center justify-center p-4 z-50">
        <div id="modal-content" class="w-full max-w-sm card p-6 rounded-2xl shadow-2xl border-2 border-blue-600/50">
            <!-- Modal Content rendered by custom functions -->
        </div>
    </div>

    <!-- Bottom Navigation Bar (Fixed for Mobile) -->
    <nav class="fixed bottom-0 left-0 right-0 h-16 bg-[#1e293b] border-t border-[#334155] max-w-md mx-auto z-30 shadow-2xl" style="background: var(--dark-blue); border-color: var(--accent-blue);">
        <div class="flex justify-around h-full items-center">
            <button class="nav-button active flex flex-col items-center text-xs" onclick="navigateTo('home')">
                <i data-lucide="pickaxe" class="w-6 h-6"></i>
                <span class="mt-1">Mine</span>
            </button>
            <button class="nav-button flex flex-col items-center text-xs" onclick="navigateTo('tasks')">
                <i data-lucide="list-checks" class="w-6 h-6"></i>
                <span class="mt-1">Tasks</span>
            </button>
            <button class="nav-button flex flex-col items-center text-xs" onclick="navigateTo('presale')">
                <i data-lucide="rocket" class="w-6 h-6"></i>
                <span class="mt-1">Presale</span>
            </button>
            <button class="nav-button flex flex-col items-center text-xs" onclick="navigateTo('boost')">
                <i data-lucide="zap" class="w-6 h-6"></i>
                <span class="mt-1">Boost</span>
            </button>
            <button class="nav-button flex flex-col items-center text-xs" onclick="navigateTo('airdrop')">
                <i data-lucide="gift" class="w-6 h-6"></i>
                <span class="mt-1">Airdrop</span>
            </button>
             <button class="nav-button flex flex-col items-center text-xs" onclick="navigateTo('wallet')">
                <i data-lucide="wallet" class="w-6 h-6"></i>
                <span class="mt-1">Wallet</span>
            </button>
        </div>
    </nav>

    <script>
        // --- BACKEND CONFIGURATION ---
        const BACKEND_URL = 'https://quotex-backend-production.up.railway.app';
        
        // --- GLOBAL STATE & CONFIGURATION ---
        const QTX_TOKEN = "QTX";
        const PRESALE_RATE = 7.0; // 1 TON = 7 QTX
        const BASE_FARMING_REWARD = 0.2;
        const FARMING_COOLDOWN_MS = 6 * 60 * 60 * 1000; // 6 hours
        const WELCOME_REWARD = 1.0;
        const REFERRAL_COMMISSION_RATE = 0.10; // 10% commission on friend's base farm claim
        const QUOTEX_JOIN_LINK = 'https://qxbroker.com/en/sign-in/';
        const QUOTEX_REWARD_MS = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
        
        const TOTAL_SUPPLY = 10000000;

        // Tokenomics data for the Whitepaper section
        const TOKEN_ALLOCATION = {
            farmingRewards: { 
                percentage: 25, 
                tokens: 0.25 * TOTAL_SUPPLY,
                details: [
                    { name: 'Airdrop & Farming Incentives', percentage: 20, tokens: 0.20 * TOTAL_SUPPLY },
                    { name: 'Referral & Community Milestones', percentage: 5, tokens: 0.05 * TOTAL_SUPPLY },
                ]
            },
            presale: { percentage: 15, tokens: 0.15 * TOTAL_SUPPLY }, 
            team: { percentage: 5, tokens: 0.05 * TOTAL_SUPPLY },
            liquidityEcosystem: { 
                percentage: 55, 
                tokens: 0.55 * TOTAL_SUPPLY 
            }, 
        };

        const REFERRAL_TIERS = [
            { count: 1, reward: 2.0, claimed: false },
            { count: 3, reward: 5.0, claimed: false },
            { count: 10, reward: 15.0, claimed: false },
        ];

        const BOOST_PACKAGES = [
            { name: "Bronze Miner", multiplier: 1.5, durationHours: 24, priceTon: 0.1, icon: 'shield' },
            { name: "Silver Drill", multiplier: 2.0, durationHours: 48, priceTon: 0.25, icon: 'shield-half' },
            { name: "Gold Rig", multiplier: 3.0, durationHours: 72, priceTon: 0.5, icon: 'shield-check' },
            { name: "Diamond Core", multiplier: 5.0, durationHours: 120, priceTon: 1.0, icon: 'sparkles' },
            { name: "Mega Whale", multiplier: 10.0, durationHours: 168, priceTon: 2.5, icon: 'gem' },
        ];

        const DAILY_REWARDS_SCHEDULE = [
            0.2, 0.2, 0.2, 0.2, 0.4, 
            0.4, 0.4, 0.4, 0.4, 0.6, 
            0.6, 0.6, 0.6, 0.6, 3.0, 
            0.8, 0.8, 0.8, 0.8, 1.0, 
            1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 10.0
        ];
        
        let globalState = {
            currentPage: 'home',
            
            // User Data
            userId: null,
            balance: 0.0,
            farmClaimCount: 0,
            referralCount: 0,
            currentRank: 0,
            
            connectedWallet: null,
            walletBalance: 0.0,
            
            // Farming State
            farmReadyTime: 0, 
            
            // Task State
            tasks: {
                joinTelegram: { completed: false, reward: 10.0, title: 'Join Telegram Channel' },
                followTwitter: { completed: false, reward: 10.0, title: 'Follow us on X (Twitter)' },
                joinCommunity: { completed: false, reward: 7.0, title: 'Join Telegram Community' },
                quotex: { 
                    completed: false, 
                    reward: 12.5, 
                    title: 'Join Quotex platform', 
                    status: 'initial', 
                    quotexId: null, 
                    idEntryTime: 0 
                },
                presaleBonus: { 
                    completed: false, 
                    reward: 15.0, 
                    title: 'Presale Purchase Bonus (Min 0.1 TON)',
                    metRequirement: false,
                },
            },
            referralTiers: JSON.parse(JSON.stringify(REFERRAL_TIERS)), 

            // Presale History
            presaleHistory: [],
            
            // Boost State
            activeBoost: {
                multiplier: 1.0,
                endTime: 0,
                name: 'None',
            },
            boostFaqOpen: false, 
            presaleFaqOpen: false, 
            whitepaperOpen: false, 
            
            // Daily Check-in State
            dailyCheckin: {
                streak: 0,
                lastClaim: 0,
            },
            
            // UI State
            notification: null,
            welcomeClaimed: false,
        };

        // TON Connect Variables
        let tonConnectUI = null;
        let isTonConnectInitialized = false;

        // --- BACKEND API FUNCTIONS ---
        
        async function saveStateToBackend() {
            if (!globalState.userId) return;
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/users/${globalState.userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        balance: globalState.balance,
                        farmClaimCount: globalState.farmClaimCount,
                        referralCount: globalState.referralCount,
                        currentRank: globalState.currentRank,
                        connectedWallet: globalState.connectedWallet,
                        farmReadyTime: globalState.farmReadyTime,
                        tasks: globalState.tasks,
                        referralTiers: globalState.referralTiers,
                        presaleHistory: globalState.presaleHistory,
                        activeBoost: globalState.activeBoost,
                        dailyCheckin: globalState.dailyCheckin,
                        welcomeClaimed: globalState.welcomeClaimed,
                        lastUpdated: Date.now()
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save state to backend');
                }

                console.log("State saved to backend");
            } catch (error) {
                console.error("Error saving to backend:", error);
            }
        }
        
        async function loadStateFromBackend() {
            if (!globalState.userId) return;
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/users/${globalState.userId}`);
                if (!response.ok) {
                    // If user doesn't exist, create one
                    if (response.status === 404) {
                        await saveStateToBackend();
                        return;
                    }
                    throw new Error('Failed to load state from backend');
                }
                
                const data = await response.json();
                if (data) {
                    // Update global state with backend data
                    globalState.balance = data.balance || 0.0;
                    globalState.farmClaimCount = data.farmClaimCount || 0;
                    globalState.referralCount = data.referralCount || 0;
                    globalState.currentRank = data.currentRank || 0;
                    globalState.connectedWallet = data.connectedWallet || null;
                    globalState.farmReadyTime = data.farmReadyTime || 0;
                    globalState.tasks = data.tasks || globalState.tasks;
                    globalState.referralTiers = data.referralTiers || globalState.referralTiers;
                    globalState.presaleHistory = data.presaleHistory || [];
                    globalState.activeBoost = data.activeBoost || globalState.activeBoost;
                    globalState.dailyCheckin = data.dailyCheckin || globalState.dailyCheckin;
                    globalState.welcomeClaimed = data.welcomeClaimed || false;
                    
                    console.log("State loaded from backend");
                    renderPage();
                }
            } catch (error) {
                console.error("Error loading from backend:", error);
            }
        }

        async function handleRealPresalePurchase(tonAmount) {
            if (!globalState.connectedWallet) {
                showNotification("Please connect your TON wallet first!", 3000);
                return false;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/presale/purchase`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: globalState.userId,
                        walletAddress: globalState.connectedWallet,
                        tonAmount: tonAmount,
                        timestamp: Date.now()
                    })
                });

                if (!response.ok) {
                    throw new Error('Purchase failed');
                }

                const result = await response.json();
                return result.success;
            } catch (error) {
                console.error("Error processing presale purchase:", error);
                return false;
            }
        }

        async function verifyQuotexId(quotexId) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/tasks/verify-quotex`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: globalState.userId,
                        quotexId: quotexId,
                        timestamp: Date.now()
                    })
                });

                if (!response.ok) {
                    throw new Error('Verification failed');
                }

                const result = await response.json();
                return result.verified;
            } catch (error) {
                console.error("Error verifying Quotex ID:", error);
                return false;
            }
        }

        async function submitReferral(referrerId) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/referrals/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        referrerId: referrerId,
                        refereeId: globalState.userId,
                        timestamp: Date.now()
                    })
                });

                return response.ok;
            } catch (error) {
                console.error("Error submitting referral:", error);
                return false;
            }
        }

        // --- TON CONNECT INTEGRATION ---

        function initializeTonConnect() {
            if (isTonConnectInitialized) return;

            try {
                // Initialize TON Connect
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: 'https://tranquil-licorice-9cec1c.netlify.app/tonconnect-manifest.json',
                    buttonRootId: 'ton-connect-button',
                    actionsConfiguration: {
                        twaReturnUrl: 'https://t.me/Quotexhouse_bot'
                    }
                });

                // Set up event listeners
                tonConnectUI.onStatusChange((wallet) => {
                    if (wallet) {
                        globalState.connectedWallet = wallet.account.address;
                        // In a real app, you would fetch actual balance from blockchain
                        globalState.walletBalance = Math.random() * 10; 
                        showNotification("TON Wallet Connected Successfully!", 3000);
                        saveStateToBackend();
                    } else {
                        globalState.connectedWallet = null;
                        globalState.walletBalance = 0.0;
                    }
                    renderPage();
                });

                // Check if wallet is already connected
                tonConnectUI.connectionRestored.then(() => {
                    console.log("Connection restored");
                });

                isTonConnectInitialized = true;
                
            } catch (error) {
                console.error("TON Connect initialization failed:", error);
                showNotification("TON Connect initialization failed", 3000);
            }
        }

        function disconnectWallet() {
            if (tonConnectUI) {
                tonConnectUI.disconnect();
                globalState.connectedWallet = null;
                globalState.walletBalance = 0.0;
                showNotification("Wallet Disconnected", 3000);
                saveStateToBackend();
                renderPage();
            }
        }

        // --- CORE UI FUNCTIONS ---

        function updateNav(page) {
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`[onclick="navigateTo('${page}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        function navigateTo(page) {
            globalState.currentPage = page;
            renderPage();
            updateNav(page);
            if (typeof lucide !== 'undefined') lucide.createIcons();
            document.getElementById('app').scrollTop = 0;
        }
        
        function showNotification(message, duration = 3000) {
            globalState.notification = message;
            renderPage(); 
            setTimeout(() => {
                globalState.notification = null;
                renderPage();
            }, duration);
        }
        
        function showGenericModal(title, bodyHtml, buttonHtml, isCheckin=false) {
            const modal = document.getElementById('generic-modal');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = `
                <div class="text-center">
                    <h3 class="text-2xl font-extrabold text-blue-400 mb-2 professional-heading">${title}</h3>
                </div>
                
                <div class="p-4 rounded-xl mb-4 text-center">
                    ${bodyHtml}
                </div>

                ${buttonHtml}
                <button onclick="document.getElementById('generic-modal').style.display='none'" class="w-full mt-2 py-2 text-sm text-gray-400 hover:text-white transition ${isCheckin ? 'hidden' : ''}">Close</button>
            `;

            modal.style.display = 'flex';
            lucide.createIcons();
        }

        // --- QUOTEX TASK LOGIC ---

        function handleQuotexJoin() {
            if (globalState.tasks.quotex.status !== 'initial') return;

            const title = "Quotex ID Verification Note";
            const bodyHtml = `
                <i data-lucide="shield-alert" class="w-10 h-10 text-red-400 mx-auto mb-3"></i>
                <p class="text-gray-300 mb-4 font-semibold text-left border-l-4 border-red-500 pl-3">
                    Note: Our algorithm does not currently verify whether you are entering a real ID or a fake one, so please make sure that your Quotex ID is genuine.
                </p>
                <p class="text-sm text-gray-500 mt-2">
                    You will be redirected to the Quotex sign-in page.
                </p>
            `;
            const buttonHtml = `
                <button 
                    onclick="agreeAndRedirect()" 
                    class="w-full py-3 bg-gradient-to-r from-green-600 to-emerald-400 text-white font-bold rounded-xl shadow-lg hover:from-green-500 transition"
                >
                    Agree & Continue
                </button>
            `;
            
            showGenericModal(title, bodyHtml, buttonHtml);
        }

        function agreeAndRedirect() {
            document.getElementById('generic-modal').style.display = 'none';
            
            globalState.tasks.quotex.status = 'pending_id'; 
            window.open(QUOTEX_JOIN_LINK, '_blank'); 
            
            showNotification("Redirected to Quotex. Please enter your ID below upon return.", 5000);
            saveStateToBackend();
            renderPage();
        }

        async function submitQuotexId() {
            const quotexInput = document.getElementById('quotex-id-input');
            const id = quotexInput.value.trim();
            
            if (id.length < 5) {
                showNotification("Please enter a valid Quotex ID (5+ characters).", 3000);
                return;
            }

            globalState.tasks.quotex.quotexId = id;
            globalState.tasks.quotex.status = 'loading';
            globalState.tasks.quotex.idEntryTime = Date.now();

            // Verify with backend
            const verified = await verifyQuotexId(id);
            
            if (verified) {
                globalState.tasks.quotex.status = 'complete';
                globalState.tasks.quotex.completed = true;
                globalState.balance += globalState.tasks.quotex.reward;
                showNotification(`Quotex ID verified! +${globalState.tasks.quotex.reward.toFixed(1)} ${QTX_TOKEN} credited.`, 5000);
            } else {
                globalState.tasks.quotex.status = 'pending_id';
                showNotification("Quotex ID verification failed. Please try again.", 3000);
            }

            saveStateToBackend();
            renderPage();
        }

        // --- WELCOME & INITIALIZATION ---

        function showWelcomePopup() {
            if (globalState.welcomeClaimed) return;

            const title = "Welcome to QTX Mining!";
            const bodyHtml = `
                <i data-lucide="trophy" class="w-12 h-12 text-yellow-400 mx-auto mb-4"></i>
                <p class="text-gray-300 mb-4">
                    Claim your starting bonus and begin your airdrop journey.
                </p>
                <div class="bg-gray-800 p-4 rounded-xl mb-6 border border-blue-600/50 shadow-inner">
                    <span class="text-2xl font-black text-green-400 block">${WELCOME_REWARD.toFixed(1)} ${QTX_TOKEN}</span>
                    <span class="text-sm text-gray-400">Initial Deposit Credited</span>
                </div>
            `;
            const buttonHtml = `
                <button onclick="claimWelcomeReward()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-sky-400 text-white font-bold rounded-xl shadow-lg hover:from-blue-500 transition">
                    Begin Mining
                </button>
            `;

            showGenericModal(title, bodyHtml, buttonHtml, true);
        }

        function claimWelcomeReward() {
            globalState.balance += WELCOME_REWARD;
            globalState.welcomeClaimed = true;
            document.getElementById('generic-modal').style.display = 'none';
            showNotification(`+${WELCOME_REWARD.toFixed(1)} ${QTX_TOKEN} Welcome Bonus!`);
            saveStateToBackend();
            renderPage();
        }

        // --- TIMER UTILITIES ---

        function formatTimeRemaining(ms) {
            if (ms <= 0) return "00:00:00";
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return [hours, minutes, seconds]
                .map(v => v.toString().padStart(2, '0'))
                .join(':');
        }
        
        let generalTimerInterval = null;

        function startTimers() {
            clearInterval(generalTimerInterval);

            generalTimerInterval = setInterval(() => {
                if (globalState.currentPage === 'home') {
                    renderFarmButton();
                }
            }, 1000);
        }
        
        // --- DAILY CHECK-IN LOGIC & UI ---

        function getDailyRewardDetails() {
            const streak = globalState.dailyCheckin.streak;
            const rewardIndex = streak % DAILY_REWARDS_SCHEDULE.length;
            const reward = DAILY_REWARDS_SCHEDULE[rewardIndex];
            
            const today = new Date().toDateString();
            const lastClaimDate = new Date(globalState.dailyCheckin.lastClaim).toDateString();
            const claimedToday = today === lastClaimDate;

            return {
                streak,
                currentDay: (rewardIndex === 0 && streak > 0) ? DAILY_REWARDS_SCHEDULE.length : rewardIndex + 1,
                reward: reward.toFixed(1),
                claimedToday,
            };
        }

        function showCheckinModal() {
            const { streak, currentDay, reward, claimedToday } = getDailyRewardDetails();
            
            if (claimedToday) {
                 showNotification("You've already claimed your daily reward today!", 3000);
                 return;
            }

            const daysHtml = DAILY_REWARDS_SCHEDULE.map((r, index) => {
                const day = index + 1;
                const isClaimed = day <= streak;
                const isCurrent = day === currentDay;
                const isBonus = day === 15 || day === 30;

                let classes = 'p-1 rounded-lg text-center font-bold transition-all duration-300 shadow-md';
                if (isClaimed) {
                    classes += ' bg-green-700/50 text-white border border-green-500';
                } else if (isCurrent) {
                    classes += ' bg-blue-600/90 text-white border-2 border-yellow-400 scale-105';
                } else {
                    classes += ' bg-gray-700 border border-gray-600 text-gray-400';
                }

                return `
                    <div class="${classes}">
                        <div class="text-xs">Day ${day}</div>
                        <div class="text-sm ${isBonus ? 'text-red-300' : 'text-yellow-300'}">${r} QTX</div>
                    </div>
                `;
            }).join('');

            const title = "Daily Check-in Reward";
            const bodyHtml = `
                <p class="text-gray-400 mb-4">
                    Current Streak: <span class="text-green-400 font-bold">${streak} Days</span>
                </p>
                
                <div class="grid grid-cols-5 gap-2 custom-scroll max-h-56 overflow-y-auto p-2 mb-6 border border-gray-700 rounded-lg">
                    ${daysHtml}
                </div>

                <div class="bg-gray-800 p-3 rounded-xl mb-4 text-center border border-blue-600/50">
                    <p class="text-sm text-gray-400">Today's Reward (Day ${currentDay})</p>
                    <span class="text-3xl font-black text-yellow-300">${reward} ${QTX_TOKEN}</span>
                </div>
            `;
            const buttonHtml = `
                <button 
                    id="claim-daily-btn"
                    onclick="claimDailyCheckin()" 
                    ${claimedToday ? 'disabled' : ''}
                    class="w-full py-3 bg-gradient-to-r from-blue-600 to-sky-400 text-white font-bold rounded-xl shadow-lg hover:from-blue-500 transition disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    ${claimedToday ? 'Claimed Today' : `Claim Now (+${reward} ${QTX_TOKEN})`}
                </button>
            `;

            showGenericModal(title, bodyHtml, buttonHtml);
        }
        
        function claimDailyCheckin() {
            const { reward, claimedToday } = getDailyRewardDetails();
            if (claimedToday) return;

            globalState.balance += parseFloat(reward);
            globalState.dailyCheckin.streak = (globalState.dailyCheckin.streak % 30) + 1;
            globalState.dailyCheckin.lastClaim = Date.now();
            
            document.getElementById('generic-modal').style.display = 'none';
            
            showNotification(`Daily Check-in Success! +${reward} ${QTX_TOKEN}`, 4000);
            saveStateToBackend();
            renderPage();
        }

        function renderCheckinButton() {
            const container = document.getElementById('daily-checkin-container');
            if (!container) return; 
            
            const { claimedToday } = getDailyRewardDetails();
            const buttonState = claimedToday ? 'checked-in-fixed' : 'centered';

            if (buttonState === 'centered') {
                container.innerHTML = `
                    <button 
                        onclick="showCheckinModal()"
                        class="w-full py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white font-bold rounded-xl shadow-xl hover:from-green-700 transition transform active:scale-[0.98] text-sm glow-button floating-action"
                    >
                        <i data-lucide="calendar-check" class="w-4 h-4 inline mr-2"></i>
                        DAILY CHECK-IN BONUS
                    </button>
                `;
                container.classList.remove('checked-in-fixed');
                container.classList.add('mb-4', 'flex'); 
            } else {
                container.innerHTML = `
                    <button 
                        onclick="showCheckinModal()"
                        class="p-3 text-xs bg-green-600 text-white rounded-full shadow-2xl transition-all duration-300 hover:scale-105 border-2 border-green-300 glow-button floating-action"
                        title="Today's Check-in Complete"
                    >
                        <i data-lucide="check" class="w-4 h-4 inline"></i>
                    </button>
                `;
                container.classList.remove('mb-4', 'flex'); 
                container.classList.add('checked-in-fixed'); 
            }
            lucide.createIcons();
        }

        // --- FARMING LOGIC ---

        function getBoostDetails() {
            const boost = globalState.activeBoost;
            const now = Date.now();
            
            if (boost.endTime > now) {
                const msRemaining = boost.endTime - now;
                return {
                    multiplier: boost.multiplier,
                    isActive: true,
                    timeRemaining: formatTimeRemaining(msRemaining),
                    name: boost.name,
                };
            }
            if (boost.isActive && boost.endTime <= now) {
                globalState.activeBoost = { multiplier: 1.0, endTime: 0, name: 'None' };
            }

            return { multiplier: 1.0, isActive: false, timeRemaining: 'Inactive', name: 'None' };
        }

        function getFarmStatus() {
            const now = Date.now();
            const msRemaining = globalState.farmReadyTime - now;
            
            const boost = getBoostDetails();
            const finalReward = BASE_FARMING_REWARD * boost.multiplier;
            
            const commission = globalState.referralCount > 0 ? BASE_FARMING_REWARD * REFERRAL_COMMISSION_RATE : 0;
            const totalClaimReward = finalReward + commission;

            if (msRemaining <= 0) {
                globalState.farmReadyTime = 0;
                return {
                    isReady: true,
                    timeDisplay: "READY!",
                    reward: totalClaimReward.toFixed(2),
                    commission: commission.toFixed(2),
                };
            } else {
                return {
                    isReady: false,
                    timeDisplay: formatTimeRemaining(msRemaining),
                    reward: totalClaimReward.toFixed(2),
                    commission: commission.toFixed(2),
                };
            }
        }

        function renderFarmButton() {
            const farmButtonContainer = document.getElementById('farm-button-container');
            if (!farmButtonContainer) return; 
            
            const status = getFarmStatus();
            let buttonHtml;

            if (status.isReady) {
                buttonHtml = `
                    <button id="farm-claim-btn" onclick="handleFarmClaim()" 
                        class="w-full py-4 rounded-xl font-black text-2xl text-white shadow-2xl transition-all duration-300 transform active:scale-[0.95]
                               bg-gradient-to-r from-green-500 to-emerald-400 border-4 border-green-300/80 hover:shadow-green-400/90 glow-button floating-action">
                        <i data-lucide="dollar-sign" class="w-6 h-6 inline mr-2"></i>
                        CLAIM +${status.reward} ${QTX_TOKEN}
                    </button>
                `;
            } else if (globalState.farmReadyTime === 0) {
                buttonHtml = `
                    <button id="farm-start-btn" onclick="startFarmingCycle()" 
                        class="w-full py-4 rounded-xl font-black text-2xl text-white shadow-2xl transition-all duration-300 transform active:scale-[0.95]
                               bg-gradient-to-r from-blue-600 to-sky-500 border-4 border-sky-300/80 hover:shadow-sky-400/90 glow-button floating-action">
                        <i data-lucide="play" class="w-6 h-6 inline mr-2"></i>
                        START MINING
                    </button>
                `;
            } else {
                buttonHtml = `
                    <div class="text-center">
                        <p class="text-gray-400 font-semibold mb-3 text-base">Next Claim in:</p>
                        <div class="farm-timer-display text-center py-4">
                            <div class="timer-digits">${status.timeDisplay}</div>
                            <div class="timer-label">HOURS : MINUTES : SECONDS</div>
                        </div>
                    </div>
                `;
            }
            farmButtonContainer.innerHTML = buttonHtml;
            lucide.createIcons();
            
            const statsHtml = `
                <div class="stats-grid mt-4">
                    <div class="stat-item">
                        <span class="text-xs text-gray-400 flex items-center mb-1">
                            <i data-lucide="layers" class="w-4 h-4 mr-1 text-green-400"></i>
                            Base Reward
                        </span>
                        <span class="text-lg font-bold text-white">${BASE_FARMING_REWARD.toFixed(1)} ${QTX_TOKEN}</span>
                    </div>
                    <div class="stat-item">
                        <span class="text-xs text-gray-400 flex items-center mb-1">
                            <i data-lucide="users" class="w-4 h-4 mr-1 text-yellow-400"></i>
                            Ref. Commission (10%)
                        </span>
                        <span class="text-lg font-bold text-yellow-300">+${status.commission} ${QTX_TOKEN}</span>
                    </div>
                </div>
            `;
            const farmStatsContainer = document.getElementById('farm-stats-container');
            if (farmStatsContainer) {
                farmStatsContainer.innerHTML = statsHtml;
                lucide.createIcons();
            }
        }

        function startFarmingCycle() {
            globalState.farmReadyTime = Date.now() + FARMING_COOLDOWN_MS;
            showNotification("Mining cycle started! Claim in 6 hours.");
            saveStateToBackend();
            renderFarmButton();
        }

        function handleFarmClaim() {
            const status = getFarmStatus();
            if (!status.isReady) return;

            const totalReward = parseFloat(status.reward);
            
            globalState.balance += totalReward;
            globalState.farmReadyTime = Date.now() + FARMING_COOLDOWN_MS;
            globalState.farmClaimCount += 1;

            showNotification(`Claim Successful! +${totalReward.toFixed(2)} ${QTX_TOKEN}`);
            saveStateToBackend();
            
            const core = document.getElementById('mining-core');
            if (core) {
                core.classList.add('animate-ping');
                setTimeout(() => core.classList.remove('animate-ping'), 500);
            }
            
            renderPage(); 
        }

        // --- REFERRAL & TASK LOGIC ---

        function handleTaskClaim(key) {
            const task = globalState.tasks[key];
            if (!task || task.completed) return;

            globalState.balance += task.reward;
            task.completed = true;
            
            showNotification(`Task Completed! +${task.reward.toFixed(1)} ${QTX_TOKEN}`);
            saveStateToBackend();
            renderPage();
        }
        
        function handlePresaleBonusClaim() {
            const task = globalState.tasks.presaleBonus;
            if (!task.metRequirement || task.completed) return;

            globalState.balance += task.reward;
            task.completed = true;
            
            showNotification(`Bonus Task Completed! +${task.reward.toFixed(1)} ${QTX_TOKEN}`);
            saveStateToBackend();
            renderPage();
        }

        function handleTierClaim(index) {
            const tier = globalState.referralTiers[index];
            if (globalState.referralCount < tier.count || tier.claimed) return;

            globalState.balance += tier.reward;
            tier.claimed = true;
            
            showNotification(`Referral Milestone! +${tier.reward.toFixed(1)} ${QTX_TOKEN}`);
            saveStateToBackend();
            renderPage();
        }

        function copyReferralLink() {
            const referralLink = `https://t.me/Quotexhouse_bot?start=ref_${globalState.userId}`;
            const tempInput = document.createElement('input');
            tempInput.value = referralLink;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                document.execCommand('copy');
                showNotification('Referral Link Copied to Clipboard!');
            } catch (err) {
                showNotification('Could not copy link. Please manually copy: ' + referralLink, 5000);
            }
            document.body.removeChild(tempInput);
        }

        function shareReferralLink() {
            const link = `https://t.me/Quotexhouse_bot?start=ref_${globalState.userId}`;
            const text = `Join the Quotex QTX Airdrop Game and start mining with me! Click here: ${link}`;

            if (navigator.share) {
                navigator.share({
                    title: 'QTX Airdrop Game Invite',
                    text: text,
                    url: link,
                }).catch(error => {
                    console.error('Sharing failed', error);
                    copyReferralLink();
                });
            } else {
                copyReferralLink();
            }
        }

        // --- FAQ & TOKENOMICS TOGGLES ---
        function toggleBoostFaq() {
            globalState.boostFaqOpen = !globalState.boostFaqOpen;
            renderPage(); 
        }
        function togglePresaleFaq() {
            globalState.presaleFaqOpen = !globalState.presaleFaqOpen;
            if (globalState.presaleFaqOpen) {
                globalState.whitepaperOpen = false;
            }
            renderPage();
        }
        function toggleWhitepaper() {
            globalState.whitepaperOpen = !globalState.whitepaperOpen;
            if (globalState.whitepaperOpen) {
                globalState.presaleFaqOpen = false;
            }
            renderPage();
        }

        // --- PROFILE FUNCTIONALITY ---
        function showProfileModal() {
            const title = "User Profile";
            const bodyHtml = `
                <div class="flex flex-col items-center mb-4">
                    <div class="w-16 h-16 rounded-full bg-blue-500 flex items-center justify-center mb-3">
                        <i data-lucide="user" class="w-8 h-8 text-white"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white">User #${globalState.userId.substring(5, 9)}</h3>
                    <p class="text-gray-400 text-sm">Mining since ${new Date().toLocaleDateString()}</p>
                </div>
                
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Total QTX Earned:</span>
                        <span class="text-white font-bold">${globalState.balance.toFixed(2)} ${QTX_TOKEN}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Referrals:</span>
                        <span class="text-white font-bold">${globalState.referralCount}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Farm Claims:</span>
                        <span class="text-white font-bold">${globalState.farmClaimCount}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Current Rank:</span>
                        <span class="text-white font-bold">#${globalState.currentRank}</span>
                    </div>
                </div>
            `;
            const buttonHtml = `
                <button onclick="document.getElementById('generic-modal').style.display='none'" class="w-full py-3 bg-gradient-to-r from-blue-600 to-sky-400 text-white font-bold rounded-xl shadow-lg hover:from-blue-500 transition">
                    Close
                </button>
            `;

            showGenericModal(title, bodyHtml, buttonHtml);
        }

        // --- PAGE RENDERERS ---

        function renderHomePage() {
            const { multiplier, isActive, timeRemaining, name } = getBoostDetails();

            return `
                <!-- Home Page Header -->
                <div class="home-header p-6 pt-8 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <button onclick="showProfileModal()" class="p-3 rounded-full bg-gray-700 hover:bg-gray-600 transition floating-action">
                            <i data-lucide="user" class="w-6 h-6 text-white"></i>
                        </button>
                        <div class="text-center">
                            <h1 class="text-3xl font-black text-white professional-heading mb-1">
                                QTX Mining
                            </h1>
                            <p class="text-xs text-gray-400">Quotex Airdrop Utility</p>
                        </div>
                        <div class="w-10"></div>
                    </div>
                    
                    <!-- Main Balance -->
                    <div class="balance-display mx-2 shadow-xl mb-4 text-center">
                        <p class="balance-label">Your Current Balance</p>
                        <div class="flex flex-col items-center mt-1">
                            <span class="balance-amount">
                                ${globalState.balance.toFixed(2)}
                            </span>
                            <span class="balance-token">${QTX_TOKEN}</span>
                        </div>
                    </div>
                </div>

                <!-- Mining Core and Button -->
                <div class="flex flex-col items-center justify-center p-4 mb-6 animated-bg">
                    <div id="mining-core" class="w-40 h-40 rounded-full flex items-center justify-center mb-6 mining-core shadow-2xl">
                        <i data-lucide="cpu" class="w-16 h-16 text-white"></i>
                    </div>

                    <div id="farm-button-container" class="w-full max-w-sm mb-6">
                        <!-- Button content rendered by renderFarmButton() -->
                    </div>

                    <div id="farm-stats-container" class="w-full max-w-sm">
                        <!-- Stats content rendered by renderFarmButton() -->
                    </div>
                </div>

                <!-- Daily Check-in Button Container -->
                <div id="daily-checkin-container" class="w-full px-4 mb-6">
                    <!-- Button content rendered by renderCheckinButton() -->
                </div>

                <!-- Section Divider -->
                <div class="section-divider mx-4"></div>

                <!-- Boost Status -->
                <div class="card p-5 mx-4 shadow-xl mb-6">
                    <h3 class="text-lg font-bold text-blue-400 mb-3 flex items-center professional-heading">
                        <i data-lucide="zap" class="w-5 h-5 mr-2 text-yellow-400"></i>
                        Active Boost Status
                    </h3>
                    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
                        <div class="stat-item">
                            <p class="text-gray-400">Multiplier</p>
                            <span class="font-bold text-yellow-300 text-xl">${multiplier}x</span>
                        </div>
                        <div class="stat-item">
                            <p class="text-gray-400">Boost Name</p>
                            <span class="font-bold text-white text-xl">${name}</span>
                        </div>
                    </div>
                    <div class="bg-gray-700/50 p-3 rounded-lg text-center border border-gray-600 mb-4">
                        <p class="text-gray-400">Time Left</p>
                        <span class="font-bold ${isActive ? 'text-green-400' : 'text-red-400'} text-xl">${timeRemaining}</span>
                    </div>
                    <button onclick="navigateTo('boost')" class="w-full py-3 text-sm bg-gradient-to-r from-purple-600 to-pink-500 text-white font-semibold rounded-lg hover:from-purple-700 transition shadow-md glow-button floating-action">
                        Upgrade Boost
                    </button>
                </div>

                <!-- Quick Stats -->
                <div class="card p-5 mx-4 shadow-xl mb-6">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center professional-heading">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-green-400"></i>
                        Quick Stats
                    </h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <p class="text-gray-400">Farm Claims</p>
                            <span class="font-bold text-white text-xl">${globalState.farmClaimCount}</span>
                        </div>
                        <div class="stat-item">
                            <p class="text-gray-400">Referrals</p>
                            <span class="font-bold text-white text-xl">${globalState.referralCount}</span>
                        </div>
                        <div class="stat-item">
                            <p class="text-gray-400">Daily Streak</p>
                            <span class="font-bold text-white text-xl">${globalState.dailyCheckin.streak}</span>
                        </div>
                        <div class="stat-item">
                            <p class="text-gray-400">Current Rank</p>
                            <span class="font-bold text-white text-xl">#${globalState.currentRank}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTasksPage() {
            const referralTiersHtml = globalState.referralTiers.map((tier, index) => {
                const canClaim = globalState.referralCount >= tier.count && !tier.claimed;
                const tierClass = tier.claimed ? 'bg-green-800/50 border-green-500' : (canClaim ? 'bg-yellow-800/50 border-yellow-500' : 'bg-gray-700 border-gray-600');
                
                return `
                    <div class="flex justify-between items-center p-4 rounded-xl mb-3 ${tierClass} border shadow-md floating-action">
                        <div class="flex flex-col">
                            <span class="font-semibold text-white">Invite ${tier.count} Friends</span>
                            <span class="text-sm text-gray-400">Bonus: +${tier.reward.toFixed(1)} ${QTX_TOKEN}</span>
                            <span class="text-xs ${globalState.referralCount >= tier.count ? 'text-green-300' : 'text-red-300'} mt-1">
                                Progress: ${globalState.referralCount} / ${tier.count}
                            </span>
                        </div>
                        <button 
                            onclick="handleTierClaim(${index})" 
                            ${canClaim ? '' : 'disabled'}
                            class="px-4 py-2 text-sm font-bold rounded-full transition-colors min-w-[120px] flex-shrink-0 
                                ${tier.claimed ? 'bg-gray-500 cursor-not-allowed' : (canClaim ? 'bg-green-600 hover:bg-green-700 shadow-md' : 'bg-gray-500 cursor-not-allowed')}">
                            ${tier.claimed ? 'Claimed' : (canClaim ? 'Claim Bonus' : 'Incomplete')}
                        </button>
                    </div>
                `;
            }).join('');
            
            const standardTasksHtml = ['joinTelegram', 'followTwitter', 'joinCommunity'].map(key => {
                const task = globalState.tasks[key];
                const icon = key.includes('Telegram Channel') ? 'send' : (key.includes('Community') ? 'users' : 'twitter');
                const link = key.includes('Telegram Channel') ? 'https://t.me/yourchannel' : (key.includes('Community') ? 'https://t.me/yourcommunity' : 'https://twitter.com/yourhandle');
                return `
                    <div class="flex justify-between items-center task-card p-4 rounded-xl mb-3 shadow-inner floating-action">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="${icon}" class="w-6 h-6 text-blue-400"></i>
                            <div class="flex flex-col">
                                <span class="font-semibold text-white">${task.title}</span>
                                <span class="text-sm text-gray-400">Reward: <span class="text-yellow-300">+${task.reward.toFixed(1)} ${QTX_TOKEN}</span></span>
                            </div>
                        </div>
                        <a href="${link}" target="_blank" onclick="${task.completed ? '' : `handleTaskClaim('${key}')`}"
                            class="px-4 py-2 text-sm font-bold rounded-full transition-colors text-center min-w-[120px] flex-shrink-0
                                ${task.completed ? 'bg-gray-500 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 glow-button'}">
                            ${task.completed ? 'Done' : 'Go & Claim'}
                        </a>
                    </div>
                `;
            }).join('');
            
            const qtxTask = globalState.tasks.quotex;
            let qtxTaskActionHtml = '';
            let qtxTaskStatusText = '';

            switch (qtxTask.status) {
                case 'initial':
                    qtxTaskActionHtml = `
                        <button onclick="handleQuotexJoin()" 
                            class="px-4 py-2 text-sm font-bold rounded-full transition-colors bg-green-600 hover:bg-green-700 min-w-[120px] flex-shrink-0 glow-button">
                            Join & Verify
                        </button>
                    `;
                    qtxTaskStatusText = 'Not Started';
                    break;

                case 'pending_id':
                    qtxTaskActionHtml = `
                        <div class="flex flex-col space-y-2 w-36 flex-shrink-0">
                            <input type="text" id="quotex-id-input" placeholder="Enter ID"
                                class="p-2 text-sm rounded-lg bg-gray-600 text-white border border-gray-700 focus:border-blue-500 placeholder-gray-400">
                            <button onclick="submitQuotexId()" 
                                class="py-2 text-sm font-bold rounded-lg transition-colors bg-blue-600 hover:bg-blue-700 min-w-[120px] glow-button">
                                Submit ID
                            </button>
                        </div>
                    `;
                    qtxTaskStatusText = 'Enter your Quotex ID';
                    break;

                case 'loading':
                    qtxTaskActionHtml = `
                        <div class="flex items-center justify-center space-x-2 text-orange-400 py-2 min-w-[120px] flex-shrink-0">
                            <i data-lucide="loader-circle" class="w-5 h-5 animate-spin"></i>
                            <span class="font-semibold text-sm">Verifying</span>
                        </div>
                    `;
                    qtxTaskStatusText = 'Verification in Progress';
                    break;

                case 'complete':
                    qtxTaskActionHtml = `
                        <span class="px-4 py-2 text-sm font-bold rounded-full bg-gray-500 cursor-not-allowed text-white text-center min-w-[120px] flex-shrink-0">
                            Completed
                        </span>
                    `;
                    qtxTaskStatusText = 'Reward Credited';
                    break;
            }

            const qtxTaskHtml = `
                <div class="flex justify-between items-center task-card p-4 rounded-xl mb-3 border border-pink-700 shadow-inner floating-action">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="trending-up" class="w-6 h-6 text-pink-400"></i>
                        <div class="flex flex-col">
                            <span class="font-semibold text-white">${qtxTask.title}</span>
                            <span class="text-sm text-gray-400">Reward: 
                                <span class="text-yellow-300">+${qtxTask.reward.toFixed(1)} ${QTX_TOKEN}</span>
                            </span>
                            <span class="text-xs text-gray-500 mt-1">Status: ${qtxTaskStatusText}</span>
                        </div>
                    </div>
                    ${qtxTaskActionHtml}
                </div>
            `;
            
            const pbTask = globalState.tasks.presaleBonus;
            const pbTaskStatusText = pbTask.metRequirement ? (pbTask.completed ? 'Reward Claimed' : 'Ready to Claim') : 'Pending Purchase';
            const pbTaskActionHtml = pbTask.completed ? 
                `<span class="px-4 py-2 text-sm font-bold rounded-full bg-gray-500 cursor-not-allowed text-white text-center min-w-[120px] flex-shrink-0">Claimed</span>` 
                : (pbTask.metRequirement ? 
                    `<button onclick="handlePresaleBonusClaim()" class="px-4 py-2 text-sm font-bold rounded-full transition-colors bg-purple-600 hover:bg-purple-700 min-w-[120px] flex-shrink-0 glow-button">Claim Reward</button>` 
                    : 
                    `<button onclick="navigateTo('presale')" class="px-4 py-2 text-sm font-bold rounded-full transition-colors bg-blue-600 hover:bg-blue-700 min-w-[120px] flex-shrink-0 glow-button">Go to Presale</button>`
                );

            const pbTaskHtml = `
                <div class="flex justify-between items-center task-card p-4 rounded-xl mb-3 border border-purple-700 shadow-inner floating-action">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="rocket" class="w-6 h-6 text-purple-400"></i>
                        <div class="flex flex-col">
                            <span class="font-semibold text-white">${pbTask.title}</span>
                            <span class="text-sm text-gray-400">Reward: 
                                <span class="text-yellow-300">+${pbTask.reward.toFixed(1)} ${QTX_TOKEN}</span>
                            </span>
                            <span class="text-xs text-gray-500 mt-1">Status: ${pbTaskStatusText}</span>
                        </div>
                    </div>
                    ${pbTaskActionHtml}
                </div>
            `;

            return `
                <!-- Tasks Page Header -->
                <div class="tasks-header p-6 pt-8 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <button onclick="showProfileModal()" class="p-3 rounded-full bg-gray-700 hover:bg-gray-600 transition floating-action">
                            <i data-lucide="user" class="w-6 h-6 text-white"></i>
                        </button>
                        <div class="text-center">
                            <h1 class="text-3xl font-black text-white professional-heading mb-1">
                                Airdrop Tasks
                            </h1>
                            <p class="text-xs text-gray-400">Complete tasks to boost your ${QTX_TOKEN} balance!</p>
                        </div>
                        <div class="w-10"></div>
                    </div>
                    
                    <!-- Tasks Progress -->
                    <div class="card p-4 mx-2 shadow-xl mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-semibold text-gray-400">Tasks Progress</span>
                            <span class="text-sm font-bold text-white">${Object.values(globalState.tasks).filter(t => t.completed).length} / ${Object.keys(globalState.tasks).length}</span>
                        </div>
                        <div class="w-full bg-gray-600 rounded-full h-2">
                            <div class="h-2 rounded-full progress-bar" style="width: ${(Object.values(globalState.tasks).filter(t => t.completed).length / Object.keys(globalState.tasks).length) * 100}%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Bonus Tasks Section -->
                <div class="card p-5 mx-4 shadow-xl mb-6">
                    <h3 class="text-xl font-bold text-pink-400 mb-3 professional-heading flex items-center">
                        <i data-lucide="star" class="w-5 h-5 mr-2 text-pink-400"></i>
                        Bonus Opportunities
                    </h3>
                    
                    <!-- Presale Bonus Task -->
                    ${pbTaskHtml}
                    
                    <!-- Quotex Platform Task -->
                    ${qtxTaskHtml}
                </div>

                <!-- Referral Section -->
                <div class="card p-5 mx-4 shadow-xl mb-6">
                    <h3 class="text-xl font-bold text-blue-400 mb-3 professional-heading flex items-center">
                        <i data-lucide="users" class="w-5 h-5 mr-2 text-blue-400"></i>
                        Invite & Earn Commission
                    </h3>
                    
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-gray-700">
                        <p class="text-white font-semibold flex justify-between items-center">
                            Your Invites: <span class="text-green-400 text-xl">${globalState.referralCount}</span>
                        </p>
                        <p class="text-sm text-gray-400 mt-2">
                            Earn 10% commission on all QTX claimed by your friends!
                        </p>
                    </div>

                    <div class="flex space-x-3 mb-4">
                        <button onclick="shareReferralLink()" class="flex-1 py-3 bg-gradient-to-r from-blue-600 to-sky-400 text-white font-bold rounded-xl hover:from-sky-500 transition shadow-md text-sm glow-button floating-action">
                            <i data-lucide="send" class="w-4 h-4 inline mr-1"></i> Share Link
                        </button>
                        <button onclick="copyReferralLink()" class="flex-1 py-3 bg-gray-600 text-white font-bold rounded-xl hover:bg-gray-700 transition shadow-md text-sm floating-action">
                            <i data-lucide="copy" class="w-4 h-4 inline mr-1"></i> Copy Link
                        </button>
                    </div>

                    <h4 class="text-lg font-bold text-blue-400 mb-3 border-t border-gray-700 pt-4">Referral Milestones</h4>
                    ${referralTiersHtml}
                </div>

                <!-- Standard Tasks -->
                <div class="card p-5 mx-4 shadow-xl mb-6">
                    <h3 class="text-xl font-bold text-green-400 mb-3 professional-heading flex items-center">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-2 text-green-400"></i>
                        Community Tasks
                    </h3>
                    ${standardTasksHtml}
                </div>
            `;
        }

        function renderPresalePage() {
            const rate = PRESALE_RATE.toFixed(1);
            const allocationKeys = Object.keys(TOKEN_ALLOCATION);
            
            const allocationHtml = allocationKeys.map(key => {
                const data = TOKEN_ALLOCATION[key];
                const isFarming = key === 'farmingRewards';
                const isLiquidity = key === 'liquidityEcosystem';
                const color = isFarming ? 'bg-green-500' : (key === 'presale' ? 'bg-pink-500' : (key === 'team' ? 'bg-red-500' : (isLiquidity ? 'bg-purple-500' : 'bg-blue-500')));
                
                let displayName = '';
                if (key === 'farmingRewards') {
                    displayName = 'Airdrop & Farming Rewards';
                } else if (key === 'liquidityEcosystem') {
                    displayName = 'Liquidity & Ecosystem (luqadalaty)'; 
                } else {
                    displayName = key.charAt(0).toUpperCase() + key.slice(1);
                }

                let detailsHtml = '';
                if (isFarming) {
                    detailsHtml = `
                        <div class="ml-2 mt-2 space-y-1 p-2 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="text-xs font-bold text-white mb-1">Breakdown (25%):</p>
                            ${data.details.map(d => `
                                <div class="flex justify-between text-xs text-gray-300">
                                    <span>${d.name} (${d.percentage}%)</span>
                                    <span class="font-semibold">${(d.tokens / 1000000).toFixed(2)}M QTX</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                return `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-white">${displayName}</span>
                            <span class="font-bold text-lg text-yellow-300">${data.percentage}%</span>
                        </div>
                        <div class="w-full bg-gray-600 rounded-full h-3">
                            <div class="h-3 rounded-full ${color}" style="width: ${data.percentage}%"></div>
                        </div>
                        ${detailsHtml}
                    </div>
                `;
            }).join('');

            return `
                <div class="p-4 pt-6">
                    <div class="card p-4 mx-4 shadow-xl mb-6">
                        <div class="flex flex-col items-center justify-center p-4 mb-4 bg-gray-800 rounded-xl border border-pink-400 shadow-inner">
                            <span class="text-xl text-gray-400 mb-1">Current Rate:</span>
                            <div class="flex items-center">
                                <span class="text-4xl font-black text-white">1 TON</span>
                                <i data-lucide="arrow-right" class="w-8 h-8 mx-4 text-pink-400"></i>
                                <span class="text-4xl font-black text-yellow-300">${rate} ${QTX_TOKEN}</span>
                            </div>
                        </div>

                        <h3 class="text-lg font-bold text-white mb-2">Purchase QTX</h3>
                        
                        <input type="number" id="ton-input" placeholder="Enter TON amount (Min 0.1)" oninput="updatePresaleEstimate()"
                            class="w-full p-3 rounded-lg bg-gray-800 text-white border border-gray-600 mb-3 focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        
                        <div class="text-right text-sm mb-3">
                            <span class="text-gray-400">Est. Reward:</span>
                            <span id="qtx-estimate" class="text-xl font-bold text-green-400 ml-2">0.0 QTX</span>
                        </div>
                        
                        <button onclick="handlePresaleBuy()" ${!globalState.connectedWallet ? 'disabled' : ''}
                            class="w-full py-3 bg-gradient-to-r from-pink-500 to-red-500 text-white font-bold rounded-xl shadow-lg hover:from-pink-600 transition transform active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed glow-button">
                            <i data-lucide="shopping-bag" class="w-5 h-5 inline mr-2"></i> 
                            ${!globalState.connectedWallet ? 'Connect Wallet First' : 'Purchase with TON'}
                        </button>
                        
                        ${!globalState.connectedWallet ? 
                            '<p class="text-xs text-red-400 mt-2 text-center">Please connect your TON wallet first</p>' : 
                            ''
                        }
                    </div>

                    <!-- FAQ and Tokenomics Buttons -->
                    <div class="mx-4 mb-4 grid grid-cols-2 gap-3">
                        <button onclick="togglePresaleFaq()" class="flex items-center justify-center px-2 py-2 text-sm font-semibold rounded-xl transition-colors bg-purple-600 hover:bg-purple-700 shadow-lg text-white">
                            <i data-lucide="help-circle" class="w-4 h-4 mr-2"></i>
                            Presale FAQ
                            <i data-lucide="${globalState.presaleFaqOpen ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4 ml-2"></i>
                        </button>
                        <button onclick="toggleWhitepaper()" class="flex items-center justify-center px-2 py-2 text-sm font-semibold rounded-xl transition-colors bg-blue-600 hover:bg-blue-700 shadow-lg text-white">
                            <i data-lucide="bar-chart-2" class="w-4 h-4 mr-2"></i>
                            Tokenomics & Statistics
                            <i data-lucide="${globalState.whitepaperOpen ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4 ml-2"></i>
                        </button>
                    </div>

                    <!-- Tokenomics Section -->
                    <div id="whitepaper-content-card" class="card p-4 mx-4 shadow-xl mb-6 ${globalState.whitepaperOpen ? '' : 'hidden'}">
                        <h3 class="text-xl font-bold text-blue-400 mb-3 professional-heading flex items-center">
                            <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2"></i>
                            QTX Tokenomics
                        </h3>
                        
                        <div class="bg-gray-800 p-3 rounded-lg border border-gray-700 mb-4 text-center">
                            <p class="text-sm text-gray-400">Total QTX Supply</p>
                            <span class="text-3xl font-black text-white">${(TOTAL_SUPPLY / 1000000).toFixed(0)} Million Tokens</span>
                        </div>

                        <h4 class="text-lg font-bold text-white mb-2 border-b border-gray-700 pb-1">Token Allocation Breakdown:</h4>
                        ${allocationHtml}
                    </div>

                    <!-- Presale FAQ Section -->
                    <div id="presale-faq-card" class="card p-4 mx-4 shadow-xl mb-6 border border-gray-700 ${globalState.presaleFaqOpen ? '' : 'hidden'}">
                        <h3 class="text-xl font-bold text-yellow-400 mb-3 professional-heading flex items-center">
                            <i data-lucide="lightbulb" class="w-5 h-5 mr-2"></i>
                            In-Depth Presale Mechanics
                        </h3>
                        <div class="space-y-4 text-sm">
                            <div>
                                <p class="font-semibold text-white">Q: What is the QTX Presale opportunity and how does it work?</p>
                                <p class="text-gray-400 mt-1 pl-3 border-l-2 border-yellow-500">
                                    The QTX Presale offers an exclusive opportunity for early adopters to acquire the QTX token at a preferential, fixed rate of 1 TON = ${PRESALE_RATE.toFixed(1)} QTX. Participants input the amount of TON they wish to spend, and the calculated QTX is instantly credited to your in-game balance after a mock transaction. This mechanism allows you to secure your tokens at the best available rate, maximizing your position before the public token launch and airdrop distribution.
                                </p>
                            </div>
                            <div>
                                <p class="font-semibold text-white">Q: How is the QTX price determined and why is it beneficial?</p>
                                <p class="text-gray-400 mt-1 pl-3 border-l-2 border-yellow-500">
                                    The presale rate is fixed and guaranteed to ensure the lowest entry price for our committed community members. The rate of 1 TON = ${PRESALE_RATE.toFixed(1)} QTX represents a significant discount compared to the anticipated listing price on exchanges. By purchasing QTX now, you lock in this favorable valuation, allowing you to secure a large volume of tokens and potentially insulating your investment from early market volatility upon public listing.
                                </p>
                            </div>
                            <div>
                                <p class="font-semibold text-white">Q: Who is the provider of the QTX token and what is its utility?</p>
                                <p class="text-gray-400 mt-1 pl-3 border-l-2 border-yellow-500">
                                    The QTX token is the native utility token for the entire ecosystem, proudly provided and backed by the established **Quotex binary trading platform**. QTX is designed to have significant utility post-launch, including being used for enhanced trading features, participation in exclusive rewards programs, and granting governance rights within the future Quotex community. Furthermore, the development and initial **liquidity pool** of QTX are strongly supported by major institutional investors, **Maxbit LLC** and **Awesamo LTD**, ensuring a stable foundation and robust launch. Participation in the presale is a direct investment in the long-term utility and success of the platform.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Presale History -->
                    <div class="card p-4 mx-4 shadow-xl mb-6 border border-gray-700">
                        <h3 class="text-xl font-bold text-white mb-3 professional-heading">Purchase History</h3>
                        ${globalState.presaleHistory.length > 0 ? 
                            globalState.presaleHistory.map(item => `
                                <div class="flex justify-between text-sm py-2 border-b border-gray-700 last:border-b-0">
                                    <span class="text-gray-400">${item.timestamp}</span>
                                    <span class="font-semibold text-white">${item.ton} TON</span>
                                    <span class="text-green-400 font-bold">+${item.qtx} ${QTX_TOKEN}</span>
                                </div>
                            `).join('')
                            : '<p class="text-gray-500 text-sm">No purchases yet. Start now!</p>'}
                    </div>
                </div>
            `;
        }
        
        function updatePresaleEstimate() {
            const tonInput = document.getElementById('ton-input');
            const estimateSpan = document.getElementById('qtx-estimate');
            if (tonInput && estimateSpan) {
                const tonAmount = parseFloat(tonInput.value) || 0;
                const qtxEstimate = tonAmount * PRESALE_RATE;
                estimateSpan.textContent = `${qtxEstimate.toFixed(2)} ${QTX_TOKEN}`;
            }
        }
        
        async function handlePresaleBuy() {
            if (!globalState.connectedWallet) {
                showNotification("Please connect your TON wallet first!", 3000);
                return;
            }

            const tonInput = document.getElementById('ton-input');
            const tonAmount = parseFloat(tonInput.value);
            if (!tonAmount || tonAmount <= 0.1) {
                showNotification("Minimum purchase is 0.1 TON.", 3000);
                return;
            }

            // Process real purchase with backend
            const purchaseSuccess = await handleRealPresalePurchase(tonAmount);
            
            if (purchaseSuccess) {
                const qtxAmount = tonAmount * PRESALE_RATE;
                globalState.balance += qtxAmount;
                globalState.presaleHistory.unshift({
                    ton: tonAmount.toFixed(2),
                    qtx: qtxAmount.toFixed(2),
                    timestamp: new Date().toLocaleTimeString(),
                });

                if (tonAmount >= 0.1 && !globalState.tasks.presaleBonus.metRequirement) {
                    globalState.tasks.presaleBonus.metRequirement = true;
                    showNotification("Presale criteria met! Claim your bonus on the Tasks page.", 6000);
                }

                showNotification(`Presale Success! ${tonAmount} TON bought ${qtxAmount.toFixed(2)} QTX.`, 5000);
                saveStateToBackend();
                tonInput.value = '';
                updatePresaleEstimate();
                renderPage();
            } else {
                showNotification("Purchase failed. Please try again.", 3000);
            }
        }

        function renderBoostPage() {
            const boostDetails = getBoostDetails();

            return `
                <div class="p-4 pt-6">
                    <div class="card p-4 mx-4 shadow-xl mb-6">
                        <h3 class="text-lg font-bold text-white mb-2 flex items-center border-b border-gray-700 pb-2 professional-heading">
                            <i data-lucide="gauge" class="w-5 h-5 mr-2 text-blue-400"></i>
                            Current Multiplier: <span class="ml-2 ${boostDetails.isActive ? 'text-yellow-300' : 'text-gray-400'}">${boostDetails.multiplier}x</span>
                        </h3>
                        <div class="flex justify-between items-center text-sm text-gray-400 pt-2">
                            <span>Time Remaining:</span>
                            <span class="font-bold ${boostDetails.isActive ? 'text-green-400' : 'text-red-400'}">${boostDetails.timeRemaining}</span>
                        </div>
                    </div>

                    <!-- Boost FAQ Button/Toggle -->
                    <div class="mx-4 mb-4 flex justify-center">
                        <button onclick="toggleBoostFaq()" class="flex items-center px-4 py-2 text-sm font-semibold rounded-full transition-colors bg-purple-600 hover:bg-purple-700 shadow-lg text-white">
                            <i data-lucide="help-circle" class="w-4 h-4 mr-2"></i>
                            Booster Mechanics FAQ
                            <i data-lucide="${globalState.boostFaqOpen ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4 ml-2"></i>
                        </button>
                    </div>
                    
                    <!-- Boost FAQ Section -->
                    <div id="boost-faq-card" class="card p-4 mx-4 shadow-xl mb-6 border border-gray-700 ${globalState.boostFaqOpen ? '' : 'hidden'}">
                        <h3 class="text-xl font-bold text-yellow-400 mb-3 professional-heading flex items-center">
                            <i data-lucide="lightbulb" class="w-5 h-5 mr-2"></i>
                            Booster Mechanics
                        </h3>
                        <div class="space-y-3 text-sm">
                            <div>
                                <p class="font-semibold text-white">Q: How do the Boosters increase my earnings?</p>
                                <p class="text-gray-400 mt-1 pl-3 border-l-2 border-yellow-500">
                                    Boosters increase the amount of QTX you earn every farming cycle. When active, your base reward of ${BASE_FARMING_REWARD.toFixed(1)} QTX is multiplied by the package's factor. For example, a 2x boost grants a total reward of ${ (BASE_FARMING_REWARD * 2).toFixed(1)} QTX (plus commission) every 6 hours.
                                </p>
                            </div>
                            <div>
                                <p class="font-semibold text-white">Q: What happens when a Boost expires?</p>
                                <p class="text-gray-400 mt-1 pl-3 border-l-2 border-yellow-500">
                                    Once the purchased duration (e.g., 24 hours) is complete, your multiplier will automatically revert to 1x. You will need to purchase a new package from the Boost section to reactivate a boosted earning rate.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Packages List -->
                    <div class="grid grid-cols-2 gap-4 px-4 mb-6">
                        ${BOOST_PACKAGES.map((pkg, index) => {
                            const isCurrentActive = boostDetails.isActive && boostDetails.multiplier === pkg.multiplier;
                            const iconColor = isCurrentActive ? 'text-green-400' : 'text-blue-400';
                            const spanClass = index === BOOST_PACKAGES.length - 1 ? 'col-span-2' : 'col-span-1'; 
                            
                            return `
                            <div class="${spanClass}">
                                <div class="boost-package p-4 shadow-xl ${isCurrentActive ? 'border-green-500' : 'border-blue-500'} h-full flex flex-col justify-between">
                                    <div>
                                        <div class="flex items-center mb-3">
                                            <i data-lucide="${pkg.icon}" class="w-6 h-6 mr-2 ${iconColor}"></i>
                                            <h4 class="text-lg font-bold text-white">${pkg.name}</h4>
                                        </div>
                                        <p class="text-3xl font-extrabold text-yellow-300 mb-4">${pkg.multiplier}x</p>
                                        <div class="text-xs mb-4 space-y-1">
                                            <p class="text-gray-300">Duration: <span class="font-semibold">${pkg.durationHours} Hours</span></p>
                                            <p class="text-gray-300">Output: <span class="font-semibold">${(BASE_FARMING_REWARD * pkg.multiplier).toFixed(2)} QTX/Cycle</span></p>
                                        </div>
                                    </div>
                                    <button onclick="handleBoostPurchase('${pkg.name}', ${pkg.multiplier}, ${pkg.durationHours})"
                                        ${isCurrentActive || !globalState.connectedWallet ? 'disabled' : ''}
                                        class="w-full py-2 mt-auto bg-gradient-to-r from-blue-600 to-sky-500 text-white font-bold rounded-lg hover:from-blue-700 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed text-sm glow-button">
                                        ${isCurrentActive ? 'Active' : (!globalState.connectedWallet ? 'Connect Wallet' : `Buy for ${pkg.priceTon.toFixed(2)} TON`)}
                                    </button>
                                </div>
                            </div>
                        `;}).join('')}
                    </div>
                </div>
            `;
        }

        function renderWalletPage() {
            const walletStatus = globalState.connectedWallet ? 
                `
                <div class="wallet-status-connected p-4 rounded-xl shadow-inner mb-4">
                    <div class="flex items-center mb-2">
                        <i data-lucide="check-circle" class="w-5 h-5 text-green-400 mr-2"></i>
                        <p class="text-sm text-green-400 font-semibold">Status: CONNECTED</p>
                    </div>
                    <p class="text-xs text-white mb-2">Wallet Address:</p>
                    <div class="wallet-address text-xs mb-2">${globalState.connectedWallet}</div>
                    <div class="flex justify-between items-center mt-3">
                        <span class="text-sm text-gray-300">Balance:</span>
                        <span class="text-sm font-bold text-yellow-300">${globalState.walletBalance.toFixed(4)} TON</span>
                    </div>
                </div>
                <button onclick="disconnectWallet()" class="w-full py-3 bg-gradient-to-r from-red-600 to-pink-500 text-white font-bold rounded-xl shadow-lg hover:from-red-500 transition transform active:scale-[0.98] glow-button">
                    <i data-lucide="log-out" class="w-5 h-5 inline mr-2"></i> Disconnect Wallet
                </button>
                ` 
                : 
                `
                <div class="wallet-status-disconnected p-4 rounded-xl shadow-inner mb-4">
                    <div class="flex items-center mb-2">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-yellow-400 mr-2"></i>
                        <p class="text-sm text-yellow-400 font-semibold">Status: NOT CONNECTED</p>
                    </div>
                    <p class="text-xs text-gray-300 mt-2">Connect your TON wallet to participate in presale and receive airdrop.</p>
                </div>
                <div id="ton-connect-button" class="ton-connect-button"></div>
                `;

             return `
                <div class="p-4 pt-6">
                    <!-- Wallet Header -->
                    <div class="text-center mb-6">
                        <h1 class="text-3xl font-black text-white professional-heading mb-1">
                            Wallet
                        </h1>
                        <p class="text-sm text-gray-400">Manage your TON wallet connection</p>
                    </div>

                    <!-- QTX Balance -->
                    <div class="balance-display p-5 mx-4 shadow-xl mb-6 text-center">
                        <p class="balance-label">Your QTX Balance</p>
                        <div class="flex flex-col items-center mt-1">
                            <span class="balance-amount">
                                ${globalState.balance.toFixed(2)}
                            </span>
                            <span class="balance-token">${QTX_TOKEN}</span>
                        </div>
                    </div>

                    <!-- TonConnect Section -->
                    <div class="wallet-card p-5 mx-4 shadow-xl mb-6">
                        <h3 class="text-xl font-bold text-blue-400 mb-3 flex items-center professional-heading">
                            <i data-lucide="link" class="w-5 h-5 mr-2"></i>TON Wallet Connection
                        </h3>
                        ${walletStatus}
                        <p class="text-xs text-gray-500 mt-3 text-center">Required for Airdrop distribution and Presale purchases.</p>
                    </div>

                    <!-- Supported Wallets Info -->
                    <div class="wallet-card p-5 mx-4 shadow-xl mb-6">
                        <h3 class="text-xl font-bold text-purple-400 mb-3 professional-heading text-center">Supported Wallets</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div class="flex flex-col items-center p-4 bg-gray-800 rounded-xl border border-gray-700">
                                <div class="wallet-icon wallet-icon-telegram">
                                    <i data-lucide="smartphone" class="text-white"></i>
                                </div>
                                <div class="text-center">
                                    <p class="font-semibold text-white">Telegram Wallet</p>
                                    <p class="text-gray-400 text-xs mt-1">Built-in TON wallet in Telegram</p>
                                </div>
                            </div>
                            <div class="flex flex-col items-center p-4 bg-gray-800 rounded-xl border border-gray-700">
                                <div class="wallet-icon wallet-icon-tonkeeper">
                                    <i data-lucide="wallet" class="text-white"></i>
                                </div>
                                <div class="text-center">
                                    <p class="font-semibold text-white">Tonkeeper</p>
                                    <p class="text-gray-400 text-xs mt-1">Popular TON blockchain wallet</p>
                                </div>
                            </div>
                            <div class="flex flex-col items-center p-4 bg-gray-800 rounded-xl border border-gray-700">
                                <div class="wallet-icon wallet-icon-mytonwallet">
                                    <i data-lucide="shield" class="text-white"></i>
                                </div>
                                <div class="text-center">
                                    <p class="font-semibold text-white">MyTonWallet</p>
                                    <p class="text-gray-400 text-xs mt-1">Browser extension wallet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function handleBoostPurchase(name, multiplier, durationHours) {
            if (!globalState.connectedWallet) {
                showNotification("Please connect your TON wallet first!", 3000);
                return;
            }

            const newEndTime = Date.now() + (durationHours * 60 * 60 * 1000);
            globalState.activeBoost = {
                name,
                multiplier,
                endTime: newEndTime,
            };
            showNotification(`Boost Activated! ${multiplier}x for ${durationHours} hours.`, 5000);
            saveStateToBackend();
            renderPage();
        }

        function renderAirdropPage() {
            const completedTasks = Object.values(globalState.tasks).filter(t => t.completed).length;
            const coreTasks = Object.keys(globalState.tasks).filter(key => key !== 'presaleBonus').length; 
            const completedCoreTasks = Object.keys(globalState.tasks).filter(key => key !== 'presaleBonus' && globalState.tasks[key].completed).length;

            const progressColor = (progress) => progress >= 100 ? 'text-green-400' : 'text-orange-400';

            const FARM_CLAIM_REQ = 25;
            const INVITE_REQ = 3;

            const criteria = [
                { 
                    title: 'Connect TON Wallet', 
                    current: globalState.connectedWallet ? 'Completed' : 'Pending', 
                    progress: globalState.connectedWallet ? 100 : 0 
                },
                { 
                    title: 'Farm Claim Consistency', 
                    current: `${globalState.farmClaimCount} / ${FARM_CLAIM_REQ} Claims`, 
                    progress: (globalState.farmClaimCount / FARM_CLAIM_REQ) * 100 
                },
                { 
                    title: 'Community Tasks', 
                    current: `${completedCoreTasks} / ${coreTasks} Completed`, 
                    progress: (completedCoreTasks / coreTasks) * 100 
                },
                { 
                    title: 'Invite Friends', 
                    current: `Invited ${globalState.referralCount} Friends`, 
                    progress: globalState.referralCount >= INVITE_REQ ? 100 : (globalState.referralCount / INVITE_REQ) * 100 
                },
            ];

            return `
                <div class="p-4 pt-6">
                    <div class="card p-4 mx-4 shadow-xl mb-6">
                        <h3 class="text-xl font-bold text-white mb-3 flex items-center border-b border-gray-700 pb-2 professional-heading">
                            <i data-lucide="check-circle" class="w-5 h-5 mr-2 text-green-400"></i>
                            Eligibility Criteria
                        </h3>

                        <div class="space-y-4 pt-2">
                            ${criteria.map(c => `
                                <div class="bg-gray-800 p-3 rounded-xl border border-gray-700 shadow-inner">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-white text-sm">${c.title}</span>
                                        <span class="text-xs font-bold ${progressColor(c.progress)}">${c.current}</span>
                                    </div>
                                    <div class="w-full bg-gray-600 rounded-full h-2">
                                        <div 
                                            class="h-2 rounded-full transition-all duration-500 ${c.progress >= 100 ? 'bg-green-500' : 'bg-blue-500'}" 
                                            style="width: ${Math.min(c.progress, 100)}%"
                                        ></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="card p-4 mx-4 shadow-xl mb-6 border border-gray-700">
                        <h3 class="text-xl font-bold text-pink-400 mb-3 professional-heading">Important Airdrop Notes</h3>
                        <p class="text-sm text-gray-400">
                            Airdrop distribution will be calculated based on your total QTX earned and completion of all core criteria. Tokens will be sent to your connected TON Wallet.
                        </p>
                        <p class="text-sm text-yellow-400 mt-2">
                            <i data-lucide="alert-circle" class="w-4 h-4 inline mr-1"></i>
                            Make sure your TON wallet is connected to receive the airdrop!
                        </p>
                    </div>
                </div>
            `;
        }

        function renderPage() {
            const app = document.getElementById('app');
            let content = '';

            const notificationHtml = globalState.notification ? `
                <div class="fixed top-2 left-1/2 transform -translate-x-1/2 z-50 notification px-4 py-2 rounded-full shadow-2xl animate-pulse text-sm font-semibold transition-opacity duration-300">
                    ${globalState.notification}
                </div>
            ` : '';

            switch (globalState.currentPage) {
                case 'home':
                    content = renderHomePage();
                    break;
                case 'tasks':
                    content = renderTasksPage();
                    break;
                case 'presale':
                    content = renderPresalePage();
                    break;
                case 'boost':
                    content = renderBoostPage();
                    break;
                case 'wallet':
                    content = renderWalletPage();
                    break;
                case 'airdrop':
                    content = renderAirdropPage();
                    break;
                default:
                    content = renderHomePage();
            }

            app.innerHTML = notificationHtml + content;
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            if (globalState.currentPage === 'home') {
                renderFarmButton();
                renderCheckinButton();
            }
            if (globalState.currentPage === 'presale') {
                updatePresaleEstimate();
            }
            if (globalState.currentPage === 'wallet') {
                setTimeout(() => {
                    initializeTonConnect();
                }, 100);
            }
        }

        // --- INITIALIZATION ---
        function loadState() {
            // Generate or retrieve user ID
            const storedUserId = localStorage.getItem('qtx_user_id');
            if (storedUserId) {
                globalState.userId = storedUserId;
            } else {
                globalState.userId = 'user-' + Math.random().toString(36).substring(2, 9);
                localStorage.setItem('qtx_user_id', globalState.userId);
            }

            // Check for referral parameter
            const urlParams = new URLSearchParams(window.location.search);
            const refParam = urlParams.get('ref');
            if (refParam && refParam.startsWith('ref_')) {
                const referrerId = refParam.substring(4);
                if (referrerId !== globalState.userId) {
                    // Submit referral to backend
                    submitReferral(referrerId);
                }
            }
        }

        function saveState() {
            // Save to backend
            saveStateToBackend();
        }

        window.onload = function() {
            loadState();
            startTimers();
            renderPage();
            
            // Load state from backend after initial render
            setTimeout(() => {
                loadStateFromBackend();
            }, 1000);
            
            if (!globalState.welcomeClaimed) {
                setTimeout(showWelcomePopup, 500); 
            }
            
            // Save state periodically
            setInterval(saveState, 5000);
        };
    </script>
</body>
</html>

