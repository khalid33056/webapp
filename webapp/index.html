<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotex QTX Airdrop Game</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- TON Connect SDK -->
    <script src="https://unpkg.com/@tonconnect/ui@2.0.0-beta.5/dist/tonconnect-ui.min.js"></script>
    <style>
        /* Define Simple Blue Professional Colors */
        :root {
            --primary-blue: #0077ff; /* Clean, professional blue */
            --dark-bg: #151d28; /* Very dark background for contrast */
            --card-bg: #1e293b; /* Slightly lighter dark background for cards */
            --text-color: #e2e8f0;
        }

        body {
            background-color: var(--dark-bg); 
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
            user-select: none; 
        }
        
        /* --- General Component Styling --- */
        .card {
            background-color: var(--card-bg); 
            border: 1px solid #334155;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            transition: all 0.2s;
        }

        .professional-heading {
            color: var(--primary-blue);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        /* --- Navigation Bar --- */
        .nav-button {
            transition: all 0.2s;
            position: relative;
            color: #94a3b8; /* Simple gray for inactive */
        }
        .nav-button.active {
            color: var(--primary-blue);
            transform: scale(1.05);
            font-weight: 600;
        }
        .nav-button.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background-color: var(--primary-blue);
            border-radius: 50%;
        }

        /* --- Home Page Specifics --- */
        .mining-core {
            border: 4px solid var(--primary-blue);
            background: radial-gradient(circle, rgba(0, 119, 255, 0.3) 0%, rgba(0, 119, 255, 0.1) 70%);
            box-shadow: 0 0 20px rgba(0, 119, 255, 0.7);
        }

        /* ADJUSTED SIZE: Reduced padding and text size for a smaller timer display */
        .farm-timer-display {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--primary-blue);
            padding: 0.5rem; /* Reduced from 0.75rem */
            border-radius: 12px;
            font-family: monospace; 
            letter-spacing: 2px;
        }

        /* --- Daily Check-in Button Fixed Position --- */
        .checked-in-fixed {
            position: fixed;
            bottom: calc(4.5rem + 15px); 
            right: 15px;
            z-index: 40;
            transition: transform 0.3s ease-in-out, background-color 0.3s;
        }
        
        /* --- Boost Package Styling --- */
        .boost-package {
            background-color: #2b3952;
            border: 2px solid var(--primary-blue);
            box-shadow: 0 0 10px rgba(0, 119, 255, 0.3);
            height: 100%; 
        }

        /* Custom scrollbar for better aesthetics */
        .custom-scroll {
            overflow-y: auto;
        }
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: var(--primary-blue);
            border-radius: 2px;
        }

        /* TON Connect Button Styles */
        .ton-connect-button {
            background: linear-gradient(45deg, #0088cc, #0077ff);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ton-connect-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 119, 255, 0.4);
        }

        .ton-connect-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>

    <!-- Main App Container -->
    <div id="app" class="min-h-screen pb-20 max-w-md mx-auto relative custom-scroll">
        <!-- Content will be rendered here -->
    </div>

    <!-- Generic Full-Screen Modal (Used for Quotex Warning and Check-in) -->
    <div id="generic-modal" class="fixed inset-0 bg-gray-900/90 hidden items-center justify-center p-4 z-50">
        <div id="modal-content" class="w-full max-w-sm card p-6 rounded-2xl shadow-2xl border-2 border-blue-600/50">
            <!-- Modal Content rendered by custom functions -->
        </div>
    </div>

    <!-- Bottom Navigation Bar (Fixed for Mobile) -->
    <nav class="fixed bottom-0 left-0 right-0 h-16 bg-[#1e293b] border-t border-[#334155] max-w-md mx-auto z-30 shadow-2xl">
        <div class="flex justify-around h-full items-center">
            <button class="nav-button active flex flex-col items-center text-xs" onclick="navigateTo('home')">
                <i data-lucide="pickaxe" class="w-6 h-6"></i>
                <span class="mt-1">Mine</span>
            </button>
            <button class="nav-button flex flex-col items-center text-xs" onclick="navigateTo('tasks')">
                <i data-lucide="list-checks" class="w-6 h-6"></i>
                <span class="mt-1">Tasks</span>
            </button>
            <button class="nav-button flex flex-col items-center text-xs" onclick="navigateTo('presale')">
                <i data-lucide="rocket" class="w-6 h-6"></i>
                <span class="mt-1">Presale</span>
            </button>
            <button class="nav-button flex flex-col items-center text-xs" onclick="navigateTo('boost')">
                <i data-lucide="zap" class="w-6 h-6"></i>
                <span class="mt-1">Boost</span>
            </button>
            <button class="nav-button flex flex-col items-center text-xs" onclick="navigateTo('airdrop')">
                <i data-lucide="gift" class="w-6 h-6"></i>
                <span class="mt-1">Airdrop</span>
            </button>
             <button class="nav-button flex flex-col items-center text-xs" onclick="navigateTo('wallet')">
                <i data-lucide="wallet" class="w-6 h-6"></i>
                <span class="mt-1">Wallet</span>
            </button>
        </div>
    </nav>

    <!-- TON Connect Widget Container -->
    <div id="ton-connect-widget" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
        <div class="bg-[#1e293b] rounded-2xl p-6 max-w-sm w-full border-2 border-blue-500/50">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Connect Wallet</h3>
                <button onclick="document.getElementById('ton-connect-widget').classList.add('hidden')" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="ton-connect-container"></div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE & CONFIGURATION ---
        const QTX_TOKEN = "QTX";
        const PRESALE_RATE = 7.0; // 1 TON = 7 QTX
        const BASE_FARMING_REWARD = 0.2;
        const FARMING_COOLDOWN_MS = 6 * 60 * 60 * 1000; // 6 hours
        const WELCOME_REWARD = 1.0;
        const REFERRAL_COMMISSION_RATE = 0.10; // 10% commission on friend's base farm claim
        const QUOTEX_JOIN_LINK = 'https://qxbroker.com/en/sign-in/';
        const QUOTEX_REWARD_MS = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
        
        const TOTAL_SUPPLY = 10000000;

        // Tokenomics data for the Whitepaper section
        const TOKEN_ALLOCATION = {
            farmingRewards: { 
                percentage: 25, 
                tokens: 0.25 * TOTAL_SUPPLY,
                details: [
                    { name: 'Airdrop & Farming Incentives', percentage: 20, tokens: 0.20 * TOTAL_SUPPLY },
                    { name: 'Referral & Community Milestones', percentage: 5, tokens: 0.05 * TOTAL_SUPPLY },
                ]
            },
            presale: { percentage: 15, tokens: 0.15 * TOTAL_SUPPLY }, 
            team: { percentage: 5, tokens: 0.05 * TOTAL_SUPPLY },
            liquidityEcosystem: { 
                percentage: 55, 
                tokens: 0.55 * TOTAL_SUPPLY 
            }, 
        };

        const REFERRAL_TIERS = [
            { count: 1, reward: 2.0, claimed: false },
            { count: 3, reward: 5.0, claimed: false },
            { count: 10, reward: 15.0, claimed: false },
        ];

        const BOOST_PACKAGES = [
            { name: "Bronze Miner", multiplier: 1.5, durationHours: 24, priceTon: 0.1, icon: 'shield' },
            { name: "Silver Drill", multiplier: 2.0, durationHours: 48, priceTon: 0.25, icon: 'shield-half' },
            { name: "Gold Rig", multiplier: 3.0, durationHours: 72, priceTon: 0.5, icon: 'shield-check' },
            { name: "Diamond Core", multiplier: 5.0, durationHours: 120, priceTon: 1.0, icon: 'sparkles' },
            { name: "Mega Whale", multiplier: 10.0, durationHours: 168, priceTon: 2.5, icon: 'gem' },
        ];

        const DAILY_REWARDS_SCHEDULE = [
            0.2, 0.2, 0.2, 0.2, 0.4, 
            0.4, 0.4, 0.4, 0.4, 0.6, 
            0.6, 0.6, 0.6, 0.6, 3.0, 
            0.8, 0.8, 0.8, 0.8, 1.0, 
            1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 10.0
        ];
        
        let globalState = {
            currentPage: 'home',
            
            // User Data
            userId: 'user-' + Math.random().toString(36).substring(2, 9),
            balance: 0.0,
            farmClaimCount: 0, // Track the number of successful farm claims
            referralCount: 0,
            currentRank: 123,
            connectedWallet: null,
            walletType: null,
            
            // Farming State
            farmReadyTime: 0, 
            
            // Task State
            tasks: {
                joinTelegram: { completed: false, reward: 10.0, title: 'Join Telegram Channel' },
                followTwitter: { completed: false, reward: 10.0, title: 'Follow us on X (Twitter)' },
                joinCommunity: { completed: false, reward: 7.0, title: 'Join Telegram Community' },
                // QUOTEX TASK
                quotex: { 
                    completed: false, 
                    reward: 12.5, 
                    title: 'Join Quotex platform', 
                    // status: 'initial', 'pending_id', 'loading', 'complete'
                    status: 'initial', 
                    quotexId: null, 
                    idEntryTime: 0 
                },
                // NEW: Presale Bonus Task
                presaleBonus: { 
                    completed: false, 
                    reward: 15.0, 
                    title: 'Presale Purchase Bonus (Min 0.1 TON)',
                    metRequirement: false, // Internal flag to track if criteria was met
                },
            },
            referralTiers: JSON.parse(JSON.stringify(REFERRAL_TIERS)), 

            // Presale History (Mock Data)
            presaleHistory: [],
            
            // Boost State
            activeBoost: {
                multiplier: 1.0,
                endTime: 0,
                name: 'None',
            },
            boostFaqOpen: false, 
            presaleFaqOpen: false, 
            whitepaperOpen: false, 
            
            // Daily Check-in State
            dailyCheckin: {
                streak: 0,
                lastClaim: 0,
            },
            
            // UI State
            notification: null,
            welcomeClaimed: localStorage.getItem('qtx_welcome_claimed') === 'true',
        };

        // --- TON CONNECT INTEGRATION ---
        let tonConnectUI = null;

        function initializeTonConnect() {
            try {
                // Initialize TON Connect with your app's manifest URL
                const manifestUrl = 'https://khankhan3456.netlify.app/tonconnect-manifest.json';
                
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: manifestUrl,
                    buttonRootId: 'ton-connect-container',
                    actionsConfiguration: {
                        twaReturnUrl: 'https://t.me/your_bot'
                    }
                });

                // Restore connection if exists
                tonConnectUI.connectionRestored.then(() => {
                    updateWalletConnection();
                });

                // Subscribe to connection status changes
                tonConnectUI.onStatusChange(walletInfo => {
                    updateWalletConnection(walletInfo);
                });

            } catch (error) {
                console.error('TON Connect initialization error:', error);
                showNotification('TON Connect initialization failed. Please refresh the page.', 5000);
            }
        }

        function updateWalletConnection(walletInfo) {
            if (walletInfo) {
                const account = walletInfo.account;
                if (account) {
                    globalState.connectedWallet = account.address;
                    globalState.walletType = walletInfo.device.appName;
                    showNotification(`${walletInfo.device.appName} wallet connected!`, 3000);
                }
            } else {
                globalState.connectedWallet = null;
                globalState.walletType = null;
            }
            saveState();
            
            // Refresh wallet page if currently viewing it
            if (globalState.currentPage === 'wallet') {
                renderPage();
            }
        }

        function showTonConnectModal() {
            document.getElementById('ton-connect-widget').classList.remove('hidden');
        }

        function disconnectWallet() {
            if (tonConnectUI) {
                tonConnectUI.disconnect();
                showNotification('Wallet disconnected', 3000);
            }
        }

        // --- CORE UI FUNCTIONS ---

        function updateNav(page) {
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`[onclick="navigateTo('${page}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        function navigateTo(page) {
            globalState.currentPage = page;
            renderPage();
            updateNav(page);
            if (typeof lucide !== 'undefined') lucide.createIcons();
            document.getElementById('app').scrollTop = 0;
        }
        
        function showNotification(message, duration = 3000) {
            globalState.notification = message;
            renderPage(); 
            setTimeout(() => {
                globalState.notification = null;
                renderPage();
            }, duration);
        }
        
        function showGenericModal(title, bodyHtml, buttonHtml, isCheckin=false) {
            const modal = document.getElementById('generic-modal');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = `
                <div class="text-center">
                    <h3 class="text-2xl font-extrabold text-blue-400 mb-2 professional-heading">${title}</h3>
                </div>
                
                <div class="p-4 rounded-xl mb-4 text-center">
                    ${bodyHtml}
                </div>

                ${buttonHtml}
                <button onclick="document.getElementById('generic-modal').style.display='none'" class="w-full mt-2 py-2 text-sm text-gray-400 hover:text-white transition ${isCheckin ? 'hidden' : ''}">Close</button>
            `;

            modal.style.display = 'flex';
            lucide.createIcons();
        }

        // --- QUOTEX TASK LOGIC ---

        function handleQuotexJoin() {
            if (globalState.tasks.quotex.status !== 'initial') return;

            const title = "Quotex ID Verification Note";
            const bodyHtml = `
                <i data-lucide="shield-alert" class="w-10 h-10 text-red-400 mx-auto mb-3"></i>
                <p class="text-gray-300 mb-4 font-semibold text-left border-l-4 border-red-500 pl-3">
                    Note: Our algorithm does not currently verify whether you are entering a real ID or a fake one, so please make sure that your Quotex ID is genuine.
                </p>
                <p class="text-sm text-gray-500 mt-2">
                    You will be redirected to the Quotex sign-in page.
                </p>
            `;
            const buttonHtml = `
                <button 
                    onclick="agreeAndRedirect()" 
                    class="w-full py-3 bg-gradient-to-r from-green-600 to-emerald-400 text-white font-bold rounded-xl shadow-lg hover:from-green-500 transition"
                >
                    Agree & Continue
                </button>
            `;
            
            showGenericModal(title, bodyHtml, buttonHtml);
        }

        function agreeAndRedirect() {
            document.getElementById('generic-modal').style.display = 'none';
            
            // 1. Change status to prompt for ID entry
            globalState.tasks.quotex.status = 'pending_id'; 
            
            // 2. Redirect the user (in a new tab/window for better UX)
            window.open(QUOTEX_JOIN_LINK, '_blank'); 
            
            showNotification("Redirected to Quotex. Please enter your ID below upon return.", 5000);
            renderPage(); // Re-render tasks page to show input field
        }

        function submitQuotexId() {
            const quotexInput = document.getElementById('quotex-id-input');
            const id = quotexInput.value.trim();
            
            if (id.length < 5) {
                showNotification("Please enter a valid Quotex ID (5+ characters).", 3000);
                return;
            }

            // Set state to loading/pending
            globalState.tasks.quotex.quotexId = id;
            globalState.tasks.quotex.status = 'loading';
            globalState.tasks.quotex.idEntryTime = Date.now(); 

            showNotification(`Quotex ID submitted! Reward will be credited in 24 hours.`, 5000);
            renderPage();
        }

        function checkQuotexReward() {
            const task = globalState.tasks.quotex;
            if (task.status === 'loading' && !task.completed) {
                const now = Date.now();
                if (now - task.idEntryTime >= QUOTEX_REWARD_MS) {
                    // Task is complete!
                    task.completed = true;
                    task.status = 'complete';
                    globalState.balance += task.reward;
                    
                    showNotification(`Quotex ID verified! +${task.reward.toFixed(1)} ${QTX_TOKEN} credited.`, 5000);
                    // Force render if on tasks page
                    if (globalState.currentPage === 'tasks') {
                        renderPage();
                    }
                }
            }
        }

        // --- WELCOME & INITIALIZATION ---

        function showWelcomePopup() {
            if (globalState.welcomeClaimed) return;

            const title = "Welcome to QTX Mining!";
            const bodyHtml = `
                <i data-lucide="trophy" class="w-12 h-12 text-yellow-400 mx-auto mb-4"></i>
                <p class="text-gray-300 mb-4">
                    Claim your starting bonus and begin your airdrop journey.
                </p>
                <div class="bg-gray-800 p-4 rounded-xl mb-6 border border-blue-600/50 shadow-inner">
                    <span class="text-2xl font-black text-green-400 block">${WELCOME_REWARD.toFixed(1)} ${QTX_TOKEN}</span>
                    <span class="text-sm text-gray-400">Initial Deposit Credited</span>
                </div>
            `;
            const buttonHtml = `
                <button onclick="claimWelcomeReward()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-sky-400 text-white font-bold rounded-xl shadow-lg hover:from-blue-500 transition">
                    Begin Mining
                </button>
            `;

            showGenericModal(title, bodyHtml, buttonHtml, true); // Use true to hide generic close button for welcome modal
        }

        function claimWelcomeReward() {
            globalState.balance += WELCOME_REWARD;
            globalState.welcomeClaimed = true;
            localStorage.setItem('qtx_welcome_claimed', 'true');
            document.getElementById('generic-modal').style.display = 'none';
            showNotification(`+${WELCOME_REWARD.toFixed(1)} ${QTX_TOKEN} Welcome Bonus!`);
            renderPage();
        }

        // --- TIMER UTILITIES ---

        function formatTimeRemaining(ms) {
            if (ms <= 0) return "00:00:00";
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return [hours, minutes, seconds]
                .map(v => v.toString().padStart(2, '0'))
                .join(':');
        }
        
        let generalTimerInterval = null;

        function startTimers() {
            clearInterval(generalTimerInterval);

            generalTimerInterval = setInterval(() => {
                // Update farm button on home page
                if (globalState.currentPage === 'home') {
                    renderFarmButton();
                }
                // Check Quotex task status every 10 seconds
                checkQuotexReward();
            }, 1000);
        }
        
        // --- DAILY CHECK-IN LOGIC & UI (Simplified UI) ---

        function getDailyRewardDetails() {
            const streak = globalState.dailyCheckin.streak;
            const rewardIndex = streak % DAILY_REWARDS_SCHEDULE.length;
            const reward = DAILY_REWARDS_SCHEDULE[rewardIndex];
            
            const today = new Date().toDateString();
            const lastClaimDate = new Date(globalState.dailyCheckin.lastClaim).toDateString();
            const claimedToday = today === lastClaimDate;

            return {
                streak,
                currentDay: (rewardIndex === 0 && streak > 0) ? DAILY_REWARDS_SCHEDULE.length : rewardIndex + 1,
                reward: reward.toFixed(1),
                claimedToday,
            };
        }

        function showCheckinModal() {
            const { streak, currentDay, reward, claimedToday } = getDailyRewardDetails();
            
            if (claimedToday) {
                 showNotification("You've already claimed your daily reward today!", 3000);
                 return;
            }

            const daysHtml = DAILY_REWARDS_SCHEDULE.map((r, index) => {
                const day = index + 1;
                const isClaimed = day <= streak;
                const isCurrent = day === currentDay;
                const isBonus = day === 15 || day === 30;

                let classes = 'p-1 rounded-lg text-center font-bold transition-all duration-300 shadow-md';
                if (isClaimed) {
                    classes += ' bg-green-700/50 text-white border border-green-500';
                } else if (isCurrent) {
                    classes += ' bg-blue-600/90 text-white border-2 border-yellow-400 scale-105';
                } else {
                    classes += ' bg-gray-700 border border-gray-600 text-gray-400';
                }

                return `
                    <div class="${classes}">
                        <div class="text-xs">Day ${day}</div>
                        <div class="text-sm ${isBonus ? 'text-red-300' : 'text-yellow-300'}">${r} QTX</div>
                    </div>
                `;
            }).join('');

            const title = "Daily Check-in Reward";
            const bodyHtml = `
                <p class="text-gray-400 mb-4">
                    Current Streak: <span class="text-green-400 font-bold">${streak} Days</span>
                </p>
                
                <div class="grid grid-cols-5 gap-2 custom-scroll max-h-56 overflow-y-auto p-2 mb-6 border border-gray-700 rounded-lg">
                    ${daysHtml}
                </div>

                <div class="bg-gray-800 p-3 rounded-xl mb-4 text-center border border-blue-600/50">
                    <p class="text-sm text-gray-400">Today's Reward (Day ${currentDay})</p>
                    <span class="text-3xl font-black text-yellow-300">${reward} ${QTX_TOKEN}</span>
                </div>
            `;
            const buttonHtml = `
                <button 
                    id="claim-daily-btn"
                    onclick="claimDailyCheckin()" 
                    ${claimedToday ? 'disabled' : ''}
                    class="w-full py-3 bg-gradient-to-r from-blue-600 to-sky-400 text-white font-bold rounded-xl shadow-lg hover:from-blue-500 transition disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    ${claimedToday ? 'Claimed Today' : `Claim Now (+${reward} ${QTX_TOKEN})`}
                </button>
            `;

            showGenericModal(title, bodyHtml, buttonHtml);
        }
        
        function claimDailyCheckin() {
            const { reward, claimedToday } = getDailyRewardDetails();
            if (claimedToday) return;

            globalState.balance += parseFloat(reward);
            // Ensure streak wraps around from 30 back to 1 if fully completed
            globalState.dailyCheckin.streak = (globalState.dailyCheckin.streak % 30) + 1;
            globalState.dailyCheckin.lastClaim = Date.now();
            
            document.getElementById('generic-modal').style.display = 'none';
            
            showNotification(`Daily Check-in Success! +${reward} ${QTX_TOKEN}`, 4000);

            renderPage();
        }

        function renderCheckinButton() {
            const container = document.getElementById('daily-checkin-container');
            if (!container) return; 
            
            const { claimedToday } = getDailyRewardDetails();
            const buttonState = claimedToday ? 'checked-in-fixed' : 'centered';

            if (buttonState === 'centered') {
                // Initial/Unclaimed state (centered in the content flow)
                container.innerHTML = `
                    <button 
                        onclick="showCheckinModal()"
                        class="w-full py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-xl shadow-xl hover:from-purple-600 transition transform active:scale-[0.98] text-sm"
                    >
                        <i data-lucide="calendar-check" class="w-4 h-4 inline mr-2"></i>
                        DAILY CHECK-IN BONUS
                    </button>
                `;
                container.classList.remove('checked-in-fixed');
                container.classList.add('mb-6', 'flex'); 
            } else {
                // Claimed state (small, fixed bottom-right)
                container.innerHTML = `
                    <button 
                        onclick="showCheckinModal()"
                        class="p-3 text-xs bg-green-600 text-white rounded-full shadow-2xl transition-all duration-300 hover:scale-105 border-2 border-green-300"
                        title="Today's Check-in Complete"
                    >
                        <i data-lucide="check" class="w-4 h-4 inline"></i>
                    </button>
                `;
                container.classList.remove('mb-6', 'flex'); 
                container.classList.add('checked-in-fixed'); 
            }
            lucide.createIcons();
        }


        // --- FARMING LOGIC ---

        function getBoostDetails() {
            const boost = globalState.activeBoost;
            const now = Date.now();
            
            if (boost.endTime > now) {
                const msRemaining = boost.endTime - now;
                return {
                    multiplier: boost.multiplier,
                    isActive: true,
                    timeRemaining: formatTimeRemaining(msRemaining),
                    name: boost.name,
                };
            }
            // Deactivate boost if expired
            if (boost.isActive && boost.endTime <= now) {
                globalState.activeBoost = { multiplier: 1.0, endTime: 0, name: 'None' };
            }

            return { multiplier: 1.0, isActive: false, timeRemaining: 'Inactive', name: 'None' };
        }

        function getFarmStatus() {
            const now = Date.now();
            const msRemaining = globalState.farmReadyTime - now;
            
            const boost = getBoostDetails();
            const finalReward = BASE_FARMING_REWARD * boost.multiplier;
            
            const commission = globalState.referralCount > 0 ? BASE_FARMING_REWARD * REFERRAL_COMMISSION_RATE : 0;
            const totalClaimReward = finalReward + commission;

            if (msRemaining <= 0) {
                globalState.farmReadyTime = 0; // Reset just in case
                return {
                    isReady: true,
                    timeDisplay: "READY!",
                    reward: totalClaimReward.toFixed(2),
                    commission: commission.toFixed(2),
                };
            } else {
                return {
                    isReady: false,
                    timeDisplay: formatTimeRemaining(msRemaining),
                    reward: totalClaimReward.toFixed(2),
                    commission: commission.toFixed(2),
                };
            }
        }

        function renderFarmButton() {
            const farmButtonContainer = document.getElementById('farm-button-container');
            if (!farmButtonContainer) return; 
            
            const status = getFarmStatus();
            let buttonHtml;

            if (status.isReady) {
                // CLAIM BUTTON
                buttonHtml = `
                    <button id="farm-claim-btn" onclick="handleFarmClaim()" 
                        class="w-full py-4 rounded-xl font-black text-2xl text-white shadow-2xl transition-all duration-300 transform active:scale-[0.95]
                               bg-gradient-to-r from-green-500 to-emerald-400 border-4 border-green-300/80 hover:shadow-green-400/90">
                        <i data-lucide="dollar-sign" class="w-6 h-6 inline mr-2"></i>
                        CLAIM +${status.reward} ${QTX_TOKEN}
                    </button>
                `;
            } else if (globalState.farmReadyTime === 0) {
                // START MINING BUTTON
                buttonHtml = `
                    <button id="farm-start-btn" onclick="startFarmingCycle()" 
                        class="w-full py-4 rounded-xl font-black text-2xl text-white shadow-2xl transition-all duration-300 transform active:scale-[0.95]
                               bg-gradient-to-r from-blue-600 to-sky-500 border-4 border-sky-300/80 hover:shadow-sky-400/90">
                        <i data-lucide="play" class="w-6 h-6 inline mr-2"></i>
                        START MINING
                    </button>
                `;
            } else {
                // Cooldown State: Timer Display
                buttonHtml = `
                    <div class="text-center">
                        <p class="text-gray-400 font-semibold mb-2 text-base">Next Claim in:</p>
                        <div class="farm-timer-display text-5xl font-black text-white tracking-widest">
                            ${status.timeDisplay}
                        </div>
                    </div>
                `;
            }
            farmButtonContainer.innerHTML = buttonHtml;
            lucide.createIcons();
            
            // Render additional farming stats below the button
            const statsHtml = `
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <div class="p-3 card border-green-500/50">
                        <span class="text-xs text-gray-400 flex items-center mb-1">
                            <i data-lucide="layers" class="w-4 h-4 mr-1 text-green-400"></i>
                            Base Reward
                        </span>
                        <span class="text-lg font-bold text-white">${BASE_FARMING_REWARD.toFixed(1)} ${QTX_TOKEN}</span>
                    </div>
                    <div class="p-3 card border-yellow-500/50">
                        <span class="text-xs text-gray-400 flex items-center mb-1">
                            <i data-lucide="users" class="w-4 h-4 mr-1 text-yellow-400"></i>
                            Ref. Commission (10%)
                        </span>
                        <span class="text-lg font-bold text-yellow-300">+${status.commission} ${QTX_TOKEN}</span>
                    </div>
                </div>
            `;
            const farmStatsContainer = document.getElementById('farm-stats-container');
            if (farmStatsContainer) {
                farmStatsContainer.innerHTML = statsHtml;
                lucide.createIcons();
            }
        }

        function startFarmingCycle() {
            globalState.farmReadyTime = Date.now() + FARMING_COOLDOWN_MS;
            showNotification("Mining cycle started! Claim in 6 hours.");
            renderFarmButton();
        }

        function handleFarmClaim() {
            const status = getFarmStatus();
            if (!status.isReady) return;

            const totalReward = parseFloat(status.reward);
            
            globalState.balance += totalReward;
            globalState.farmReadyTime = Date.now() + FARMING_COOLDOWN_MS; 
            globalState.farmClaimCount += 1; // Increment farm claim counter

            showNotification(`Claim Successful! +${totalReward.toFixed(2)} ${QTX_TOKEN}`);
            
            const core = document.getElementById('mining-core');
            if (core) {
                core.classList.add('animate-ping');
                setTimeout(() => core.classList.remove('animate-ping'), 500);
            }
            
            renderPage(); 
        }

        // --- REFERRAL & TASK LOGIC ---

        function handleTaskClaim(key) {
            const task = globalState.tasks[key];
            if (!task || task.completed) return;

            globalState.balance += task.reward;
            task.completed = true;
            
            showNotification(`Task Completed! +${task.reward.toFixed(1)} ${QTX_TOKEN}`);
            renderPage();
        }
        
        // NEW: Handler for the Presale Bonus Claim
        function handlePresaleBonusClaim() {
            const task = globalState.tasks.presaleBonus;
            if (!task.metRequirement || task.completed) return;

            globalState.balance += task.reward;
            task.completed = true;
            
            showNotification(`Bonus Task Completed! +${task.reward.toFixed(1)} ${QTX_TOKEN}`);
            renderPage();
        }


        function handleTierClaim(index) {
            const tier = globalState.referralTiers[index];
            if (globalState.referralCount < tier.count || tier.claimed) return;

            globalState.balance += tier.reward;
            tier.claimed = true;
            
            showNotification(`Referral Milestone! +${tier.reward.toFixed(1)} ${QTX_TOKEN}`);
            renderPage();
        }

        function copyReferralLink() {
            const referralLink = `https://t.me/YourBot?start=ref_${globalState.userId}`;
            const tempInput = document.createElement('input');
            tempInput.value = referralLink;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                document.execCommand('copy');
                showNotification('Referral Link Copied to Clipboard!');
            } catch (err) {
                showNotification('Could not copy link. Please manually copy: ' + referralLink, 5000);
            }
            document.body.removeChild(tempInput);
        }

        function shareReferralLink() {
            const link = `https://t.me/YourBot?start=ref_${globalState.userId}`;
            const text = `Join the Quotex QTX Airdrop Game and start mining with me! Click here: ${link}`;

            if (navigator.share) {
                navigator.share({
                    title: 'QTX Airdrop Game Invite',
                    text: text,
                    url: link,
                }).catch(error => {
                    console.error('Sharing failed', error);
                    copyReferralLink(); 
                });
            } else {
                copyReferralLink();
            }
        }

        // --- FAQ & TOKENOMICS TOGGLES ---
        function toggleBoostFaq() {
            globalState.boostFaqOpen = !globalState.boostFaqOpen;
            renderPage(); 
        }
        function togglePresaleFaq() {
            globalState.presaleFaqOpen = !globalState.presaleFaqOpen;
            if (globalState.presaleFaqOpen) {
                globalState.whitepaperOpen = false;
            }
            renderPage();
        }
        function toggleWhitepaper() {
            globalState.whitepaperOpen = !globalState.whitepaperOpen;
            if (globalState.whitepaperOpen) {
                globalState.presaleFaqOpen = false;
            }
            renderPage();
        }


        // --- PAGE RENDERERS ---

        function renderHomePage() {
            const { multiplier, isActive, timeRemaining, name } = getBoostDetails();

            return `
                <header class="text-center p-4 pt-6">
                    <h1 class="text-3xl font-black text-white professional-heading mb-1">
                        QTX Mining Core
                    </h1>
                    <p class="text-xs text-gray-400">Quotex Airdrop Utility</p>
                </header>
                
                <!-- Main Balance -->
                <div class="card p-4 mx-4 shadow-xl mb-6 border-2 border-yellow-400/50">
                    <p class="text-sm font-medium text-gray-400">Your Current Balance</p>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-5xl font-black text-yellow-400 tracking-wide">
                            ${globalState.balance.toFixed(2)}
                        </span>
                        <span class="text-2xl font-bold text-yellow-400">${QTX_TOKEN}</span>
                    </div>
                </div>

                <!-- Mining Core and Button -->
                <div class="flex flex-col items-center justify-center p-4">
                    <div id="mining-core" class="w-36 h-36 rounded-full flex items-center justify-center mb-6 mining-core shadow-2xl">
                        <i data-lucide="cpu" class="w-12 h-12 text-white"></i>
                    </div>

                    <div id="farm-button-container" class="w-full max-w-sm mb-6">
                        <!-- Button content rendered by renderFarmButton() -->
                    </div>

                    <div id="farm-stats-container" class="w-full max-w-sm">
                        <!-- Stats content rendered by renderFarmButton() -->
                    </div>
                </div>

                <!-- Daily Check-in Button Container (Handles fixed positioning if claimed) -->
                <div id="daily-checkin-container" class="w-full">
                    <!-- Button content rendered by renderCheckinButton() -->
                </div>

                <!-- Boost Status -->
                <div class="card p-4 mx-4 shadow-xl mb-6 border-2 border-blue-500/50">
                    <h3 class="text-lg font-bold text-blue-400 mb-3 flex items-center professional-heading">
                        <i data-lucide="zap" class="w-5 h-5 mr-2 text-yellow-400"></i>
                        Active Boost Status
                    </h3>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-gray-700/50 p-2 rounded-lg text-center border border-gray-600">
                            <p class="text-gray-400">Multiplier</p>
                            <span class="font-bold text-yellow-300 text-xl">${multiplier}x</span>
                        </div>
                        <div class="bg-gray-700/50 p-2 rounded-lg text-center border border-gray-600">
                            <p class="text-gray-400">Boost Name</p>
                            <span class="font-bold text-white text-xl">${name}</span>
                        </div>
                        <div class="col-span-2 bg-gray-700/50 p-2 rounded-lg text-center border border-gray-600">
                            <p class="text-gray-400">Time Left</p>
                            <span class="font-bold ${isActive ? 'text-green-400' : 'text-red-400'} text-xl">${timeRemaining}</span>
                        </div>
                    </div>
                    <button onclick="navigateTo('boost')" class="w-full py-2 mt-3 text-sm bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition shadow-md">
                        Upgrade Boost
                    </button>
                </div>
            `;
        }

        function renderTasksPage() {
            const taskKeys = Object.keys(globalState.tasks);

            const referralTiersHtml = globalState.referralTiers.map((tier, index) => {
                const canClaim = globalState.referralCount >= tier.count && !tier.claimed;
                const tierClass = tier.claimed ? 'bg-green-800/50 border-green-500' : (canClaim ? 'bg-yellow-800/50 border-yellow-500' : 'bg-gray-700 border-gray-600');
                
                return `
                    <div class="flex justify-between items-center p-3 rounded-lg mb-3 ${tierClass} border shadow-md">
                        <div class="flex flex-col">
                            <span class="font-semibold text-white">Invite ${tier.count} Friends</span>
                            <span class="text-sm text-gray-400">Bonus: +${tier.reward.toFixed(1)} ${QTX_TOKEN}</span>
                            <span class="text-xs ${globalState.referralCount >= tier.count ? 'text-green-300' : 'text-red-300'} mt-1">
                                Progress: ${globalState.referralCount} / ${tier.count}
                            </span>
                        </div>
                        <button 
                            onclick="handleTierClaim(${index})" 
                            ${canClaim ? '' : 'disabled'}
                            class="px-4 py-2 text-sm font-bold rounded-full transition-colors min-w-[120px] flex-shrink-0 
                                ${tier.claimed ? 'bg-gray-500 cursor-not-allowed' : (canClaim ? 'bg-green-600 hover:bg-green-700 shadow-md' : 'bg-gray-500 cursor-not-allowed')}">
                            ${tier.claimed ? 'Claimed' : (canClaim ? 'Claim Bonus' : 'Incomplete')}
                        </button>
                    </div>
                `;
            }).join('');
            
            // Render the standard task list
            const standardTasksHtml = ['joinTelegram', 'followTwitter', 'joinCommunity'].map(key => {
                const task = globalState.tasks[key];
                const icon = key.includes('Telegram Channel') ? 'send' : (key.includes('Community') ? 'users' : 'twitter');
                const link = key.includes('Telegram Channel') ? 'https://t.me/yourchannel' : (key.includes('Community') ? 'https://t.me/yourcommunity' : 'https://twitter.com/yourhandle');
                return `
                    <div class="flex justify-between items-center bg-gray-800 p-3 rounded-xl mb-3 border border-gray-700 shadow-inner">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="${icon}" class="w-6 h-6 text-blue-400"></i>
                            <div class="flex flex-col">
                                <span class="font-semibold text-white">${task.title}</span>
                                <span class="text-sm text-gray-400">Reward: <span class="text-yellow-300">+${task.reward.toFixed(1)} ${QTX_TOKEN}</span></span>
                            </div>
                        </div>
                        <a href="${link}" target="_blank" onclick="${task.completed ? '' : `handleTaskClaim('${key}')`}"
                            class="px-4 py-2 text-sm font-bold rounded-full transition-colors text-center min-w-[120px] flex-shrink-0
                                ${task.completed ? 'bg-gray-500 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}">
                            ${task.completed ? 'Done' : 'Go & Claim'}
                        </a>
                    </div>
                `;
            }).join('');
            
            // --- QUOTEX TASK RENDER LOGIC ---
            const qtxTask = globalState.tasks.quotex;
            let qtxTaskActionHtml = '';
            let qtxTaskStatusText = '';

            switch (qtxTask.status) {
                case 'initial':
                    qtxTaskActionHtml = `
                        <button onclick="handleQuotexJoin()" 
                            class="px-4 py-2 text-sm font-bold rounded-full transition-colors bg-green-600 hover:bg-green-700 min-w-[120px] flex-shrink-0">
                            Join & Verify
                        </button>
                    `;
                    qtxTaskStatusText = 'Not Started';
                    break;

                case 'pending_id':
                    // Using w-36 to give enough space for input and button, and flex-shrink-0 to maintain width
                    qtxTaskActionHtml = `
                        <div class="flex flex-col space-y-2 w-36 flex-shrink-0">
                            <input type="text" id="quotex-id-input" placeholder="Enter ID"
                                class="p-2 text-sm rounded-lg bg-gray-600 text-white border border-gray-700 focus:border-blue-500 placeholder-gray-400">
                            <button onclick="submitQuotexId()" 
                                class="py-2 text-sm font-bold rounded-lg transition-colors bg-blue-600 hover:bg-blue-700 min-w-[120px]">
                                Submit ID
                            </button>
                        </div>
                    `;
                    qtxTaskStatusText = 'Enter your Quotex ID';
                    break;

                case 'loading':
                    const msRemaining = qtxTask.idEntryTime + QUOTEX_REWARD_MS - Date.now();
                    const timeRemaining = formatTimeRemaining(msRemaining);
                    qtxTaskActionHtml = `
                        <div class="flex items-center justify-center space-x-2 text-orange-400 py-2 min-w-[120px] flex-shrink-0">
                            <i data-lucide="loader-circle" class="w-5 h-5 animate-spin"></i>
                            <span class="font-semibold text-sm">Pending</span>
                        </div>
                    `;
                    qtxTaskStatusText = 'Verification in Progress (' + timeRemaining + ')';
                    break;

                case 'complete':
                    qtxTaskActionHtml = `
                        <span class="px-4 py-2 text-sm font-bold rounded-full bg-gray-500 cursor-not-allowed text-white text-center min-w-[120px] flex-shrink-0">
                            Completed
                        </span>
                    `;
                    qtxTaskStatusText = 'Reward Credited';
                    break;
            }

            const qtxTaskHtml = `
                <div class="flex justify-between items-center bg-gray-800 p-3 rounded-xl mb-3 border border-pink-700 shadow-inner">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="trending-up" class="w-6 h-6 text-pink-400"></i>
                        <div class="flex flex-col">
                            <span class="font-semibold text-white">${qtxTask.title}</span>
                            <span class="text-sm text-gray-400">Reward: 
                                <span class="text-yellow-300">+${qtxTask.reward.toFixed(1)} ${QTX_TOKEN}</span>
                            </span>
                            <span class="text-xs text-gray-500 mt-1">Status: ${qtxTaskStatusText}</span>
                        </div>
                    </div>
                    ${qtxTaskActionHtml}
                </div>
            `;
            // --- END QUOTEX TASK RENDER LOGIC ---
            
            // --- NEW PRESALE BONUS TASK RENDER LOGIC ---
            const pbTask = globalState.tasks.presaleBonus;
            const pbTaskStatusText = pbTask.metRequirement ? (pbTask.completed ? 'Reward Claimed' : 'Ready to Claim') : 'Pending Purchase';
            const pbTaskActionHtml = pbTask.completed ? 
                `<span class="px-4 py-2 text-sm font-bold rounded-full bg-gray-500 cursor-not-allowed text-white text-center min-w-[120px] flex-shrink-0">Claimed</span>` 
                : (pbTask.metRequirement ? 
                    `<button onclick="handlePresaleBonusClaim()" class="px-4 py-2 text-sm font-bold rounded-full transition-colors bg-purple-600 hover:bg-purple-700 min-w-[120px] flex-shrink-0">Claim Reward</button>` 
                    : 
                    `<button onclick="navigateTo('presale')" class="px-4 py-2 text-sm font-bold rounded-full transition-colors bg-blue-600 hover:bg-blue-700 min-w-[120px] flex-shrink-0">Go to Presale</button>`
                );

            const pbTaskHtml = `
                <div class="flex justify-between items-center bg-gray-800 p-3 rounded-xl mb-3 border border-purple-700 shadow-inner">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="rocket" class="w-6 h-6 text-purple-400"></i>
                        <div class="flex flex-col">
                            <span class="font-semibold text-white">${pbTask.title}</span>
                            <span class="text-sm text-gray-400">Reward: 
                                <span class="text-yellow-300">+${pbTask.reward.toFixed(1)} ${QTX_TOKEN}</span>
                            </span>
                            <span class="text-xs text-gray-500 mt-1">Status: ${pbTaskStatusText}</span>
                        </div>
                    </div>
                    ${pbTaskActionHtml}
                </div>
            `;
            // --- END NEW PRESALE BONUS TASK RENDER LOGIC ---


            return `
                <header class="p-4 pt-6 text-center">
                    <h2 class="text-2xl font-bold text-white professional-heading">Airdrop Tasks</h2>
                    <p class="text-sm text-gray-400 mt-1">Complete tasks to instantly boost your ${QTX_TOKEN} balance!</p>
                </header>
                
                <!-- Bonus Tasks Section -->
                <div class="card p-4 mx-4 shadow-xl mb-6 border-2 border-pink-400/50">
                    <h3 class="text-xl font-bold text-pink-400 mb-3 professional-heading">Bonus Opportunities</h3>
                    
                    <!-- Presale Bonus Task -->
                    ${pbTaskHtml}
                    
                    <!-- Quotex Platform Task -->
                    ${qtxTaskHtml}
                </div>


                <!-- Referral Section -->
                <div class="card p-4 mx-4 shadow-xl mb-6 border-2 border-blue-400/50">
                    <h3 class="text-xl font-bold text-blue-400 mb-3 professional-heading">Invite & Earn Commission</h3>
                    
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-gray-700">
                        <p class="text-white font-semibold flex justify-between items-center">
                            Your Invites: <span class="text-green-400 text-xl">${globalState.referralCount}</span>
                        </p>
                        <p class="text-sm text-gray-400 mt-2">
                            Earn 10% commission on all QTX claimed by your friends!
                        </p>
                    </div>

                    <div class="flex space-x-3 mb-4">
                        <button onclick="shareReferralLink()" class="flex-1 py-3 bg-gradient-to-r from-blue-600 to-sky-400 text-white font-bold rounded-xl hover:from-sky-500 transition shadow-md text-sm">
                            <i data-lucide="send" class="w-4 h-4 inline mr-1"></i> Share Link
                        </button>
                        <button onclick="copyReferralLink()" class="flex-1 py-3 bg-gray-600 text-white font-bold rounded-xl hover:bg-gray-700 transition shadow-md text-sm">
                            <i data-lucide="copy" class="w-4 h-4 inline mr-1"></i> Copy Link
                        </button>
                    </div>

                    <h4 class="text-lg font-bold text-blue-400 mb-3 border-t border-gray-700 pt-4">Referral Milestones</h4>
                    ${referralTiersHtml}
                </div>

                <!-- Standard Tasks -->
                <div class="card p-4 mx-4 shadow-xl mb-6 border-2 border-green-400/50">
                    <h3 class="text-xl font-bold text-green-400 mb-3 professional-heading">Community Tasks</h3>
                    ${standardTasksHtml}
                </div>
            `;
        }

        function renderPresalePage() {
            const rate = PRESALE_RATE.toFixed(1);
            const allocationKeys = Object.keys(TOKEN_ALLOCATION);
            
            const allocationHtml = allocationKeys.map(key => {
                const data = TOKEN_ALLOCATION[key];
                const isFarming = key === 'farmingRewards';
                const isLiquidity = key === 'liquidityEcosystem';
                const color = isFarming ? 'bg-green-500' : (key === 'presale' ? 'bg-pink-500' : (key === 'team' ? 'bg-red-500' : (isLiquidity ? 'bg-purple-500' : 'bg-blue-500')));
                
                let displayName = '';
                if (key === 'farmingRewards') {
                    displayName = 'Airdrop & Farming Rewards';
                } else if (key === 'liquidityEcosystem') {
                    displayName = 'Liquidity & Ecosystem (luqadalaty)'; 
                } else {
                    displayName = key.charAt(0).toUpperCase() + key.slice(1);
                }

                let detailsHtml = '';
                if (isFarming) {
                    detailsHtml = `
                        <div class="ml-2 mt-2 space-y-1 p-2 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="text-xs font-bold text-white mb-1">Breakdown (25%):</p>
                            ${data.details.map(d => `
                                <div class="flex justify-between text-xs text-gray-300">
                                    <span>${d.name} (${d.percentage}%)</span>
                                    <span class="font-semibold">${(d.tokens / 1000000).toFixed(2)}M QTX</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                return `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-white">${displayName}</span>
                            <span class="font-bold text-lg text-yellow-300">${data.percentage}%</span>
                        </div>
                        <div class="w-full bg-gray-600 rounded-full h-3">
                            <div class="h-3 rounded-full ${color}" style="width: ${data.percentage}%"></div>
                        </div>
                        ${detailsHtml}
                    </div>
                `;
            }).join('');


            return `
                <header class="p-4 pt-6 text-center">
                    <h2 class="text-2xl font-bold text-white professional-heading">Exclusive QTX Presale</h2>
                    <p class="text-sm text-gray-400 mt-1">Secure ${QTX_TOKEN} at the best rate before listing.</p>
                </header>

                <div class="card p-4 mx-4 shadow-xl mb-6 border-2 border-pink-400/50">
                    <div class="flex flex-col items-center justify-center p-4 mb-4 bg-gray-800 rounded-xl border border-pink-400 shadow-inner">
                        <span class="text-xl text-gray-400 mb-1">Current Rate:</span>
                        <div class="flex items-center">
                            <span class="text-4xl font-black text-white">1 TON</span>
                            <i data-lucide="arrow-right" class="w-8 h-8 mx-4 text-pink-400"></i>
                            <span class="text-4xl font-black text-yellow-300">${rate} ${QTX_TOKEN}</span>
                        </div>
                    </div>

                    <h3 class="text-lg font-bold text-white mb-2">Purchase QTX</h3>
                    
                    <input type="number" id="ton-input" placeholder="Enter TON amount (Min 0.1)" oninput="updatePresaleEstimate()"
                        class="w-full p-3 rounded-lg bg-gray-800 text-white border border-gray-600 mb-3 focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    
                    <div class="text-right text-sm mb-3">
                        <span class="text-gray-400">Est. Reward:</span>
                        <span id="qtx-estimate" class="text-xl font-bold text-green-400 ml-2">0.0 QTX</span>
                    </div>
                    
                    <button onclick="handlePresaleBuy()" class="w-full py-3 bg-gradient-to-r from-pink-500 to-red-500 text-white font-bold rounded-xl shadow-lg hover:from-pink-600 transition transform active:scale-[0.98]">
                        <i data-lucide="shopping-bag" class="w-5 h-5 inline mr-2"></i> Purchase with TON
                    </button>
                </div>

                <!-- FAQ and Tokenomics Buttons (Side-by-Side) -->
                <div class="mx-4 mb-4 grid grid-cols-2 gap-3">
                    <button onclick="togglePresaleFaq()" class="flex items-center justify-center px-2 py-2 text-sm font-semibold rounded-xl transition-colors bg-purple-600 hover:bg-purple-700 shadow-lg text-white">
                        <i data-lucide="help-circle" class="w-4 h-4 mr-2"></i>
                        Presale FAQ
                        <i data-lucide="${globalState.presaleFaqOpen ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4 ml-2"></i>
                    </button>
                    <!-- Button Name: Tokenomics & Statistics -->
                    <button onclick="toggleWhitepaper()" class="flex items-center justify-center px-2 py-2 text-sm font-semibold rounded-xl transition-colors bg-blue-600 hover:bg-blue-700 shadow-lg text-white">
                        <i data-lucide="bar-chart-2" class="w-4 h-4 mr-2"></i>
                        Tokenomics & Statistics
                        <i data-lucide="${globalState.whitepaperOpen ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4 ml-2"></i>
                    </button>
                </div>

                <!-- Tokenomics Section (Toggled by button) -->
                <div id="whitepaper-content-card" class="card p-4 mx-4 shadow-xl mb-6 border-2 border-blue-500 ${globalState.whitepaperOpen ? '' : 'hidden'}">
                    <h3 class="text-xl font-bold text-blue-400 mb-3 professional-heading flex items-center">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2"></i>
                        QTX Tokenomics
                    </h3>
                    
                    <div class="bg-gray-800 p-3 rounded-lg border border-gray-700 mb-4 text-center">
                        <p class="text-sm text-gray-400">Total QTX Supply</p>
                        <span class="text-3xl font-black text-white">${(TOTAL_SUPPLY / 1000000).toFixed(0)} Million Tokens</span>
                    </div>

                    <h4 class="text-lg font-bold text-white mb-2 border-b border-gray-700 pb-1">Token Allocation Breakdown:</h4>
                    ${allocationHtml}
                </div>

                <!-- Presale FAQ Section (Toggled by button) -->
                <div id="presale-faq-card" class="card p-4 mx-4 shadow-xl mb-6 border border-gray-700 ${globalState.presaleFaqOpen ? '' : 'hidden'}">
                    <h3 class="text-xl font-bold text-yellow-400 mb-3 professional-heading flex items-center">
                        <i data-lucide="lightbulb" class="w-5 h-5 mr-2"></i>
                        In-Depth Presale Mechanics
                    </h3>
                    <div class="space-y-4 text-sm">
                        <div>
                            <p class="font-semibold text-white">Q: What is the QTX Presale opportunity and how does it work?</p>
                            <p class="text-gray-400 mt-1 pl-3 border-l-2 border-yellow-500">
                                The QTX Presale offers an exclusive opportunity for early adopters to acquire the QTX token at a preferential, fixed rate of 1 TON = ${PRESALE_RATE.toFixed(1)} QTX. Participants input the amount of TON they wish to spend, and the calculated QTX is instantly credited to your in-game balance after a mock transaction. This mechanism allows you to secure your tokens at the best available rate, maximizing your position before the public token launch and airdrop distribution.
                            </p>
                        </div>
                        <div>
                            <p class="font-semibold text-white">Q: How is the QTX price determined and why is it beneficial?</p>
                            <p class="text-gray-400 mt-1 pl-3 border-l-2 border-yellow-500">
                                The presale rate is fixed and guaranteed to ensure the lowest entry price for our committed community members. The rate of 1 TON = ${PRESALE_RATE.toFixed(1)} QTX represents a significant discount compared to the anticipated listing price on exchanges. By purchasing QTX now, you lock in this favorable valuation, allowing you to secure a large volume of tokens and potentially insulating your investment from early market volatility upon public listing.
                            </p>
                        </div>
                        <div>
                            <p class="font-semibold text-white">Q: Who is the provider of the QTX token and what is its utility?</p>
                            <p class="text-gray-400 mt-1 pl-3 border-l-2 border-yellow-500">
                                The QTX token is the native utility token for the entire ecosystem, proudly provided and backed by the established **Quotex binary trading platform**. QTX is designed to have significant utility post-launch, including being used for enhanced trading features, participation in exclusive rewards programs, and granting governance rights within the future Quotex community. Furthermore, the development and initial **liquidity pool** of QTX are strongly supported by major institutional investors, **Maxbit LLC** and **Awesamo LTD**, ensuring a stable foundation and robust launch. Participation in the presale is a direct investment in the long-term utility and success of the platform.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Presale History -->
                <div class="card p-4 mx-4 shadow-xl mb-6 border border-gray-700">
                    <h3 class="text-xl font-bold text-white mb-3 professional-heading">Purchase History</h3>
                    ${globalState.presaleHistory.length > 0 ? 
                        globalState.presaleHistory.map(item => `
                            <div class="flex justify-between text-sm py-2 border-b border-gray-700 last:border-b-0">
                                <span class="text-gray-400">${item.timestamp}</span>
                                <span class="font-semibold text-white">${item.ton} TON</span>
                                <span class="text-green-400 font-bold">+${item.qtx} ${QTX_TOKEN}</span>
                            </div>
                        `).join('')
                        : '<p class="text-gray-500 text-sm">No purchases yet. Start now!</p>'}
                </div>
            `;
        }
        
        function updatePresaleEstimate() {
            const tonInput = document.getElementById('ton-input');
            const estimateSpan = document.getElementById('qtx-estimate');
            if (tonInput && estimateSpan) {
                const tonAmount = parseFloat(tonInput.value) || 0;
                const qtxEstimate = tonAmount * PRESALE_RATE;
                estimateSpan.textContent = `${qtxEstimate.toFixed(2)} ${QTX_TOKEN}`;
            }
        }
        
        function handlePresaleBuy() {
            const tonInput = document.getElementById('ton-input');
            const tonAmount = parseFloat(tonInput.value);
            if (!tonAmount || tonAmount <= 0.1) {
                showNotification("Minimum purchase is 0.1 TON.", 3000);
                return;
            }

            // Check if wallet is connected
            if (!globalState.connectedWallet) {
                showNotification("Please connect your TON wallet first!", 3000);
                navigateTo('wallet');
                return;
            }

            const qtxAmount = tonAmount * PRESALE_RATE;

            // MOCK TON CONNECT/TRANSACTION:
            globalState.balance += qtxAmount;
            globalState.presaleHistory.unshift({
                ton: tonAmount.toFixed(2),
                qtx: qtxAmount.toFixed(2),
                timestamp: new Date().toLocaleTimeString(),
            });

            // NEW: Check for Presale Bonus Task completion
            if (tonAmount >= 0.1 && !globalState.tasks.presaleBonus.metRequirement) {
                globalState.tasks.presaleBonus.metRequirement = true;
                showNotification("Presale criteria met! Claim your bonus on the Tasks page.", 6000);
            }

            showNotification(`Presale Success! ${tonAmount} TON bought ${qtxAmount.toFixed(2)} QTX.`, 5000);
            tonInput.value = '';
            updatePresaleEstimate();
            renderPage();
        }

        function renderBoostPage() {
            const boostDetails = getBoostDetails();

            return `
                <header class="p-4 pt-6 text-center">
                    <h2 class="text-2xl font-bold text-white professional-heading">Mining Boost Packages</h2>
                    <p class="text-sm text-gray-400 mt-1">Increase your farming output up to 10x!</p>
                </header>

                <!-- Active Boost Status Bar -->
                <div class="card p-4 mx-4 shadow-xl mb-6 border-2 ${boostDetails.isActive ? 'border-green-500' : 'border-gray-500'}">
                    <h3 class="text-lg font-bold text-white mb-2 flex items-center border-b border-gray-700 pb-2 professional-heading">
                        <i data-lucide="gauge" class="w-5 h-5 mr-2 text-blue-400"></i>
                        Current Multiplier: <span class="ml-2 ${boostDetails.isActive ? 'text-yellow-300' : 'text-gray-400'}">${boostDetails.multiplier}x</span>
                    </h3>
                    <div class="flex justify-between items-center text-sm text-gray-400 pt-2">
                        <span>Time Remaining:</span>
                        <span class="font-bold ${boostDetails.isActive ? 'text-green-400' : 'text-red-400'}">${boostDetails.timeRemaining}</span>
                    </div>
                </div>

                <!-- Boost FAQ Button/Toggle -->
                <div class="mx-4 mb-4 flex justify-center">
                    <button onclick="toggleBoostFaq()" class="flex items-center px-4 py-2 text-sm font-semibold rounded-full transition-colors bg-purple-600 hover:bg-purple-700 shadow-lg text-white">
                        <i data-lucide="help-circle" class="w-4 h-4 mr-2"></i>
                        Booster Mechanics FAQ
                        <i data-lucide="${globalState.boostFaqOpen ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4 ml-2"></i>
                    </button>
                </div>
                
                <!-- Boost FAQ Section (Toggled by button) -->
                <div id="boost-faq-card" class="card p-4 mx-4 shadow-xl mb-6 border border-gray-700 ${globalState.boostFaqOpen ? '' : 'hidden'}">
                    <h3 class="text-xl font-bold text-yellow-400 mb-3 professional-heading flex items-center">
                        <i data-lucide="lightbulb" class="w-5 h-5 mr-2"></i>
                        Booster Mechanics
                    </h3>
                    <div class="space-y-3 text-sm">
                        <div>
                            <p class="font-semibold text-white">Q: How do the Boosters increase my earnings?</p>
                            <p class="text-gray-400 mt-1 pl-3 border-l-2 border-yellow-500">
                                Boosters increase the amount of QTX you earn every farming cycle. When active, your base reward of ${BASE_FARMING_REWARD.toFixed(1)} QTX is multiplied by the package's factor. For example, a 2x boost grants a total reward of ${ (BASE_FARMING_REWARD * 2).toFixed(1)} QTX (plus commission) every 6 hours.
                            </p>
                        </div>
                        <div>
                            <p class="font-semibold text-white">Q: What happens when a Boost expires?</p>
                            <p class="text-gray-400 mt-1 pl-3 border-l-2 border-yellow-500">
                                Once the purchased duration (e.g., 24 hours) is complete, your multiplier will automatically revert to 1x. You will need to purchase a new package from the Boost section to reactivate a boosted earning rate.
                            </p>
                        </div>
                    </div>
                </div>


                <!-- Packages List - New 2x2x1 Layout -->
                <div class="grid grid-cols-2 gap-4 px-4 mb-6">
                    ${BOOST_PACKAGES.map((pkg, index) => {
                        const isCurrentActive = boostDetails.isActive && boostDetails.multiplier === pkg.multiplier;
                        const iconColor = isCurrentActive ? 'text-green-400' : 'text-blue-400';
                        // Last item (index 4) spans 2 columns
                        const spanClass = index === BOOST_PACKAGES.length - 1 ? 'col-span-2' : 'col-span-1'; 
                        
                        return `
                        <div class="${spanClass}">
                            <div class="card p-4 shadow-xl boost-package ${isCurrentActive ? 'border-green-500' : 'border-blue-500'} h-full flex flex-col justify-between">
                                <div>
                                    <div class="flex items-center mb-3">
                                        <i data-lucide="${pkg.icon}" class="w-6 h-6 mr-2 ${iconColor}"></i>
                                        <h4 class="text-lg font-bold text-white">${pkg.name}</h4>
                                    </div>
                                    <p class="text-3xl font-extrabold text-yellow-300 mb-4">${pkg.multiplier}x</p>
                                    <div class="text-xs mb-4 space-y-1">
                                        <p class="text-gray-300">Duration: <span class="font-semibold">${pkg.durationHours} Hours</span></p>
                                        <p class="text-gray-300">Output: <span class="font-semibold">${(BASE_FARMING_REWARD * pkg.multiplier).toFixed(2)} QTX/Cycle</span></p>
                                    </div>
                                </div>
                                <button onclick="handleBoostPurchase('${pkg.name}', ${pkg.multiplier}, ${pkg.durationHours})"
                                    ${isCurrentActive ? 'disabled' : ''}
                                    class="w-full py-2 mt-auto bg-gradient-to-r from-blue-600 to-sky-500 text-white font-bold rounded-lg hover:from-blue-700 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                                    ${isCurrentActive ? 'Active' : `Buy for ${pkg.priceTon.toFixed(2)} TON`}
                                </button>
                            </div>
                        </div>
                    `;}).join('')}
                </div>
            `;
        }

        function renderWalletPage() {
            const walletConnected = globalState.connectedWallet;
            
            return `
                <header class="p-4 pt-6 text-center">
                    <h2 class="text-2xl font-bold text-white professional-heading">Wallet & Security</h2>
                    <p class="text-sm text-gray-400 mt-1">Connect your TON wallet for Presale and future Airdrop.</p>
                </header>

                <div class="card p-4 mx-4 shadow-xl mb-6 border-2 border-yellow-400/50 text-center">
                    <h3 class="text-xl font-bold text-white mb-3">Total QTX Balance</h3>
                    <span class="text-5xl font-black text-yellow-400">
                        ${globalState.balance.toFixed(2)}
                    </span>
                    <span class="text-xl font-bold text-yellow-400 block mt-1">${QTX_TOKEN}</span>
                </div>

                <!-- TonConnect Section -->
                <div class="card p-4 mx-4 shadow-xl mb-6 border-2 border-blue-500/50">
                    <h3 class="text-xl font-bold text-blue-400 mb-3 flex items-center professional-heading">
                        <i data-lucide="link" class="w-5 h-5 mr-2"></i>TON Wallet Connection
                    </h3>
                    
                    ${walletConnected ? 
                        `
                        <div class="bg-green-900/50 p-3 rounded-xl border border-green-600 shadow-inner mb-4">
                            <p class="text-sm text-green-400 font-semibold mb-1">Status: CONNECTED</p>
                            <p class="text-xs text-white break-all mb-2">Wallet: ${globalState.walletType || 'TON Wallet'}</p>
                            <p class="text-xs text-gray-300 break-all">Address: ${globalState.connectedWallet}</p>
                        </div>
                        <button onclick="disconnectWallet()" class="w-full py-3 bg-gradient-to-r from-red-600 to-red-400 text-white font-bold rounded-xl shadow-lg hover:from-red-500 transition transform active:scale-[0.98]">
                            <i data-lucide="unlink" class="w-5 h-5 inline mr-2"></i> Disconnect Wallet
                        </button>
                        ` : 
                        `
                        <div class="mb-4 p-3 bg-yellow-900/30 rounded-xl border border-yellow-600">
                            <p class="text-sm text-yellow-400 mb-2">Connect your TON wallet to participate in presale and receive airdrop rewards.</p>
                            <p class="text-xs text-gray-400">Supported wallets: Tonkeeper, MyTonWallet, and others</p>
                        </div>
                        <button onclick="showTonConnectModal()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-sky-400 text-white font-bold rounded-xl shadow-lg hover:from-blue-500 transition transform active:scale-[0.98]">
                            <i data-lucide="wallet" class="w-5 h-5 inline mr-2"></i> Connect TON Wallet
                        </button>
                        `
                    }
                </div>

                <!-- Wallet Info Section -->
                <div class="card p-4 mx-4 shadow-xl mb-6 border-2 border-green-500/50">
                    <h3 class="text-xl font-bold text-green-400 mb-3 flex items-center professional-heading">
                        <i data-lucide="shield" class="w-5 h-5 mr-2"></i>Security Information
                    </h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex items-start">
                            <i data-lucide="check-circle" class="w-4 h-4 text-green-400 mr-2 mt-0.5 flex-shrink-0"></i>
                            <p class="text-gray-300">Your wallet connection is secure and encrypted</p>
                        </div>
                        <div class="flex items-start">
                            <i data-lucide="check-circle" class="w-4 h-4 text-green-400 mr-2 mt-0.5 flex-shrink-0"></i>
                            <p class="text-gray-300">We never have access to your private keys</p>
                        </div>
                        <div class="flex items-start">
                            <i data-lucide="check-circle" class="w-4 h-4 text-green-400 mr-2 mt-0.5 flex-shrink-0"></i>
                            <p class="text-gray-300">All transactions require your explicit approval</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function handleBoostPurchase(name, multiplier, durationHours) {
            const newEndTime = Date.now() + (durationHours * 60 * 60 * 1000);
            globalState.activeBoost = {
                name,
                multiplier,
                endTime: newEndTime,
            };
            showNotification(`Boost Activated! ${multiplier}x for ${durationHours} hours.`, 5000);
            renderPage();
        }

        function renderAirdropPage() {
            const completedTasks = Object.values(globalState.tasks).filter(t => t.completed).length;
            // Exclude presaleBonus task from total for Airdrop progress, as it's a bonus, not core requirement
            const coreTasks = Object.keys(globalState.tasks).filter(key => key !== 'presaleBonus').length; 
            const completedCoreTasks = Object.keys(globalState.tasks).filter(key => key !== 'presaleBonus' && globalState.tasks[key].completed).length;

            const progressColor = (progress) => progress >= 100 ? 'text-green-400' : 'text-orange-400';

            const FARM_CLAIM_REQ = 25; // New Requirement
            const INVITE_REQ = 3;      // New Requirement

            const criteria = [
                { 
                    title: 'Connect TON Wallet', 
                    current: globalState.connectedWallet ? 'Completed' : 'Pending', 
                    progress: globalState.connectedWallet ? 100 : 0 
                },
                { 
                    title: 'Farm Claim Consistency', 
                    current: `${globalState.farmClaimCount} / ${FARM_CLAIM_REQ} Claims`, 
                    progress: (globalState.farmClaimCount / FARM_CLAIM_REQ) * 100 
                },
                { 
                    title: 'Community Tasks', 
                    current: `${completedCoreTasks} / ${coreTasks} Completed`, 
                    progress: (completedCoreTasks / coreTasks) * 100 
                },
                { 
                    title: 'Invite Friends', 
                    current: `Invited ${globalState.referralCount} Friends`, 
                    progress: globalState.referralCount >= INVITE_REQ ? 100 : (globalState.referralCount / INVITE_REQ) * 100 
                },
            ];

            return `
                <header class="p-4 pt-6 text-center">
                    <h2 class="text-2xl font-bold text-white professional-heading">QTX Airdrop Center</h2>
                    <p class="text-sm text-gray-400 mt-1">Check your eligibility for the QTX token distribution.</p>
                </header>

                <div class="card p-4 mx-4 shadow-xl mb-6 border-2 border-green-400/50">
                    <h3 class="text-xl font-bold text-white mb-3 flex items-center border-b border-gray-700 pb-2 professional-heading">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-2 text-green-400"></i>
                        Eligibility Criteria
                    </h3>

                    <div class="space-y-4 pt-2">
                        ${criteria.map(c => `
                            <div class="bg-gray-800 p-3 rounded-xl border border-gray-700 shadow-inner">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-semibold text-white text-sm">${c.title}</span>
                                    <span class="text-xs font-bold ${progressColor(c.progress)}">${c.current}</span>
                                </div>
                                <div class="w-full bg-gray-600 rounded-full h-2">
                                    <div 
                                        class="h-2 rounded-full transition-all duration-500 ${c.progress >= 100 ? 'bg-green-500' : 'bg-blue-500'}" 
                                        style="width: ${Math.min(c.progress, 100)}%"
                                    ></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="card p-4 mx-4 shadow-xl mb-6 border border-gray-700">
                    <h3 class="text-xl font-bold text-pink-400 mb-3 professional-heading">Important Airdrop Notes</h3>
                    <p class="text-sm text-gray-400">
                        Airdrop distribution will be calculated based on your total QTX earned and completion of all core criteria. Tokens will be sent to your connected TON Wallet.
                    </p>
                </div>
            `;
        }


        function renderPage() {
            const app = document.getElementById('app');
            let content = '';

            const notificationHtml = globalState.notification ? `
                <div class="fixed top-2 left-1/2 transform -translate-x-1/2 z-50 bg-green-600 text-white px-4 py-2 rounded-full shadow-2xl animate-pulse text-sm font-semibold transition-opacity duration-300">
                    ${globalState.notification}
                </div>
            ` : '';

            switch (globalState.currentPage) {
                case 'home':
                    content = renderHomePage();
                    break;
                case 'tasks':
                    content = renderTasksPage();
                    break;
                case 'presale':
                    content = renderPresalePage();
                    break;
                case 'boost':
                    content = renderBoostPage();
                    break;
                case 'wallet':
                    content = renderWalletPage();
                    break;
                case 'airdrop':
                    content = renderAirdropPage();
                    break;
                default:
                    content = renderHomePage();
            }

            app.innerHTML = notificationHtml + content;
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            if (globalState.currentPage === 'home') {
                renderFarmButton();
                renderCheckinButton();
            }
            if (globalState.currentPage === 'presale') {
                updatePresaleEstimate();
            }
        }

        // --- INITIALIZATION ---
        function loadState() {
            if (localStorage.getItem('qtx_farm_ready_time')) {
                globalState.farmReadyTime = parseInt(localStorage.getItem('qtx_farm_ready_time'));
            }
            if (localStorage.getItem('qtx_balance')) {
                globalState.balance = parseFloat(localStorage.getItem('qtx_balance'));
            }
            if (localStorage.getItem('qtx_farm_claim_count')) { // Load farm claim count
                globalState.farmClaimCount = parseInt(localStorage.getItem('qtx_farm_claim_count'));
            }
            if (localStorage.getItem('qtx_referral_count')) {
                 globalState.referralCount = parseInt(localStorage.getItem('qtx_referral_count'));
            }
            if (localStorage.getItem('qtx_daily_checkin')) {
                globalState.dailyCheckin = JSON.parse(localStorage.getItem('qtx_daily_checkin'));
            }
            if (localStorage.getItem('qtx_boost_active')) {
                globalState.activeBoost = JSON.parse(localStorage.getItem('qtx_boost_active'));
            }
            if (localStorage.getItem('qtx_presale_history')) {
                globalState.presaleHistory = JSON.parse(localStorage.getItem('qtx_presale_history'));
            }
            if (localStorage.getItem('qtx_connected_wallet')) {
                globalState.connectedWallet = localStorage.getItem('qtx_connected_wallet');
            }
            if (localStorage.getItem('qtx_wallet_type')) {
                globalState.walletType = localStorage.getItem('qtx_wallet_type');
            }
            
            // Load Quotex task state and ensure it merges correctly with the default structure
            const savedQuotex = localStorage.getItem('qtx_quotex_task');
            if (savedQuotex) {
                const parsed = JSON.parse(savedQuotex);
                globalState.tasks.quotex = { ...globalState.tasks.quotex, ...parsed };
            }
            
            // NEW: Load Presale Bonus task state
            const savedPresaleBonus = localStorage.getItem('qtx_presale_bonus_task');
            if (savedPresaleBonus) {
                const parsed = JSON.parse(savedPresaleBonus);
                globalState.tasks.presaleBonus = { ...globalState.tasks.presaleBonus, ...parsed };
            }
            
            // Generate a random ID for this session/user if needed
            globalState.userId = 'tg-' + Math.random().toString(36).substring(2, 9);
        }

        function saveState() {
            localStorage.setItem('qtx_farm_ready_time', globalState.farmReadyTime.toString());
            localStorage.setItem('qtx_balance', globalState.balance.toFixed(2));
            localStorage.setItem('qtx_farm_claim_count', globalState.farmClaimCount.toString()); // Save farm claim count
            localStorage.setItem('qtx_referral_count', globalState.referralCount.toString());
            localStorage.setItem('qtx_daily_checkin', JSON.stringify(globalState.dailyCheckin));
            localStorage.setItem('qtx_boost_active', JSON.stringify(globalState.activeBoost));
            localStorage.setItem('qtx_presale_history', JSON.stringify(globalState.presaleHistory));
            localStorage.setItem('qtx_quotex_task', JSON.stringify(globalState.tasks.quotex));
            
            // NEW: Save Presale Bonus task state
            localStorage.setItem('qtx_presale_bonus_task', JSON.stringify(globalState.tasks.presaleBonus));

            if (globalState.connectedWallet) {
                localStorage.setItem('qtx_connected_wallet', globalState.connectedWallet);
            }
            if (globalState.walletType) {
                localStorage.setItem('qtx_wallet_type', globalState.walletType);
            }
        }

        window.onload = function() {
            loadState();
            startTimers();
            initializeTonConnect(); // Initialize TON Connect
            renderPage();
            
            if (!globalState.welcomeClaimed) {
                // Delay showing the welcome popup slightly so the main app renders first
                setTimeout(showWelcomePopup, 500); 
            }
            
            // Save state periodically
            setInterval(saveState, 5000);
        };
    </script>
</body>
</html>